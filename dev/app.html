<!DOCTYPE html>
<html lang="it" id="htmlRoot">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f0f0f">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>RIDER TRACKER PRO V1.3</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg:#0f0f0f; --card:#1a1a1a; --primary:#00CCBC; --accent:#ff4d4d; --text:#e0e0e0; --dim:#888; --input-bg:#252525; --orange:#ffa500; --red-soft:#8b0000; }
        :root {
  --vh: 100dvh;
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

* { box-sizing:border-box; -webkit-tap-highlight-color:transparent; touch-action: manipulation; }
        html { background:var(--bg); }
        body { font-family:sans-serif; background:var(--bg); color:var(--text); margin:0; padding:0; text-align:center; height: 100vh; width: 100vw; position: fixed; inset: 0; display: flex; align-items: flex-start; justify-content: flex-start; overflow: hidden; }
        
        button, .foot-btn, .btn-full, .btn-modal, .btn-option, .clickable { cursor: pointer; -webkit-user-select: none; user-select: none; }
        @media all and (display-mode: standalone) {
            body { align-items: center; justify-content: center; margin-top: 24px; }
            #mainContainer { max-height: 100vh; }
        }
        
        #mainContainer {
    width: 100%;
    max-width: 100%;
    margin: 0;
    padding: 10px 10px 12px 10px;
    box-sizing: border-box;

    overflow-y: auto;
    overflow-x: hidden;
        }

        .foot-btn:active, .btn-full:active { transform: scale(0.95); transition: 0.1s; }
        .app-title { margin:10px 0 15px; font-size:30px; font-weight:800; color:var(--primary); text-transform:uppercase; user-select:none; cursor: pointer; }
        .grid { display:grid; grid-template-columns:repeat(3, 1fr); gap:8px; margin-bottom:8px; }
        .card { background:var(--card); height:75px; display:flex; flex-direction:column; justify-content:center; align-items:center; border-radius:12px; border:1px solid #333; }
        .label { font-size:8px; color:var(--dim); text-transform:uppercase; margin-bottom:4px; font-weight:bold; }
        .val { font-size:14px; font-weight:bold; }
        .card.main .val, #lordo, #mancante { color:var(--primary)!important; } 
        #netto { color:var(--accent)!important; }
        .card input { width:80%; background:transparent; border:none; border-bottom:1px solid #444; color:#fff; text-align:center; font-size:14px; outline:none; }
        .progress-container { background:var(--card); padding:15px; border-radius:15px; margin-top: 0; margin-bottom:8px; border:1px solid #333; display: flex; flex-direction: column; gap: 8px; }
        .progress-header { display:flex; justify-content:center; font-weight:bold; color:var(--primary); font-size:14px; text-transform: uppercase; letter-spacing: 1px; }
        .progress-bar { background:#222; height:28px; border-radius:8px; overflow:hidden; border:1px solid #444; }
        #bar { background:linear-gradient(90deg, var(--primary), #ccff00); height:100%; width:0%; transition:0.3s; }
        .dash-info { display: flex; justify-content: space-between; align-items: center; padding: 0 5px; margin-top: 5px; }
        #liveClock { font-weight:bold; color:var(--dim); font-size:11px; text-transform: uppercase; }
        #mediaOraria { font-weight:bold; color:var(--primary); font-size:12px; }
        .sticky-footer {
    position:relative;
    margin-top:0;
    background:#161616;
    padding:12px 15px 12px 15px;
    display:grid;
    grid-template-columns:repeat(4, 1fr);
    gap:8px;
    border-radius:25px;
    border:1px solid #333;
    z-index:1000;
    margin-bottom:0;
}
        .foot-btn { background:#222; border:1px solid #444; color:#fff; padding:12px 5px; border-radius:15px; display:flex; flex-direction:column; align-items:center; font-size:10px; font-weight: bold; }
        .foot-btn i { font-size:20px; margin-bottom:5px; }
        .btn-full {
  grid-column:span 4;
  background:var(--primary);
  color:#000;
  padding:16px;
  border-radius:15px;
  font-weight:900;
  border:none;
  font-size:13px;
  text-transform:uppercase;

  margin-top: 8px;
  margin-bottom: 8px;
}
        .btn-reset-soft {
    grid-column: span 4;
    background: var(--red-soft);
    color: #ccc;
    border: none;
    padding: 10px;
    border-radius: 12px;
    font-weight: bold;
    font-size: 10px;
    margin-top: 8px;
    text-transform: uppercase;
        }
        .report-fixed-footer { padding: 15px; padding-bottom: 45px; border-top: 1px solid #eee; background: #fff; }
        .backup-grid, .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 10px; }
        .btn-rep-uniform { width: 100%; padding: 10px 5px; border-radius: 10px; font-weight: 700; text-transform: uppercase; font-size: 10px; display: flex; align-items: center; justify-content: center; gap: 6px; cursor: pointer; border: 1.5px solid transparent; transition: 0.2s; }
        .btn-grey-light { background: #f8f8f8; color: #555; border-color: #ddd; }
        .btn-black { background: #1a1a1a; color: #fff; }
        .btn-grey-dark { background: #666; color: #fff; }
        .btn-rep-uniform i { font-size: 12px; }
        .modal { display:none; position:fixed; inset:0; z-index:9999; background:rgba(0,0,0,0.6); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); align-items: center; justify-content: center; }
       .modal-content { background:var(--card); padding:20px; border-radius:24px; width:90%; max-width:320px; border:2px solid var(--primary); margin: auto; transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 10px 30px rgba(0,0,0,0.5); overflow: hidden; }
        .modal h3 { margin-top: 0; font-size: 18px; color: var(--primary); text-transform: uppercase; }
        .modal input { width:100%; padding:12px; background:var(--input-bg); border:1px solid #444; color:#fff; border-radius:12px; margin-bottom:10px; outline:none; font-size: 16px; }
        #histView { display:none; position:fixed; inset:0; z-index:9000; background:var(--bg); flex-direction: column; padding: 15px; }
        #listaStorico { flex-grow: 1; overflow-y: auto; margin-bottom: 15px; border-top: 1px solid #333; border-bottom: 1px solid #333; -webkit-overflow-scrolling: touch; }
        #reportView { display:none; position:fixed; inset:0; z-index:8000; background:#fff; color:#000; flex-direction:column; text-align:left; }
#chartOra, #chartKm { min-height: 200px; }
        .report-scroll-area { flex: 1; overflow-y: auto; padding: 10px; -webkit-overflow-scrolling: touch; }
        .report-header-mini { border-bottom:2px solid #000; padding-bottom:10px; margin-bottom:15px; text-align: center; }
        .report-header-mini h2 { font-size:16px; margin:0; text-transform:uppercase; color: #000; letter-spacing: 1px; }
  .report-table { 
    width: 100%; 
    border-collapse: collapse; 
    font-size: 9px; 
    margin-bottom: 15px; 
    table-layout: auto;
}
.report-table td, .report-table th { 
    padding: 3px 2px;
    white-space: nowrap;
    border: 1px solid #000;
    text-align: center;
}
        .report-table th { background: #eee; font-weight: bold; }
        .summary-box { border:2px solid #000; padding:10px; background:#fff; }
        .summary-row { display:flex; justify-content:space-between; padding:4px 0; font-size:11px; color: #000; }
        .summary-row.total { font-weight:bold; font-size:14px; border-top:2px solid #000; margin-top:5px; padding-bottom: 10px; }
       .storico-item { background:#0f0f0f; padding:15px 5px; border-top:1px solid #333; border-bottom:1px solid #333; border-radius:12px; display:flex; justify-content:space-between; align-items:center; margin-bottom: 5px; position: relative; }
        .storico-info { flex:1; text-align:left; padding: 0 10px; }
        .tipo-label { font-size:9px; font-weight:900; text-transform:uppercase; letter-spacing:1.5px; display: flex; align-items: center; gap: 5px; }
        .storico-date-row { display: flex; align-items: baseline; gap: 8px; font-weight: bold; font-size: 14px; margin-top: 2px; }
        .storico-hour { color: var(--dim); font-size: 11px; font-weight: normal; }
        .storico-main { font-size:18px; font-weight:bold; margin-top: 2px; }
        .storico-sub { font-size:10px; color:var(--dim); line-height: 1.4; }
        .btn-modal { width:100%; padding:14px; border-radius:12px; border:none; font-weight:bold; margin-top:8px; font-size: 15px; }
        .btn-save { background:var(--primary); color:#000; }
        .btn-close { background:#333; color:#fff; }
        .confirm-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .btn-confirm-ok { flex: 1; padding: 12px; border-radius: 10px; border: none; font-weight: bold; font-size: 14px; }
        .btn-confirm-cancel { background: #333; color: white; flex: 1; padding: 12px; border-radius: 10px; border: none; font-weight: bold; font-size: 14px; }
        .date-row { display:flex; gap:8px; margin-bottom:10px; }
        .date-row select { background:#333; color:#fff; padding:10px; border-radius:10px; flex:1; border:1px solid #444; font-size: 14px; } 
      #repEfficienzaBody td:nth-child(2), #repEfficienzaBody td:nth-child(4) { width: 1%; }
        .tipo-abbrev-mi { font-size: 6px; }
.btn-option {
    width: 100%;
    padding: 15px;
    background: #252525;
    border: 1px solid #444;
    color: #fff;
    border-radius: 12px;
    font-size: 16px;
    text-align: left;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 15px;
    transition: 0.2s;
}
.btn-option i { font-size: 20px; width: 25px; text-align: center; }
.btn-option:active {
    background: var(--primary);
    color: #000;
    border-color: var(--primary);
    transform: scale(0.98);
}
.fake-select {
    width: 100%; 
    padding: 12px; 
    background: #252525; 
    color: #fff; 
    border-radius: 12px; 
    border: 1px solid #444; 
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 16px;
}
.month-group {
    background: #0f0f0f;
    border: 1px solid #333;
    border-radius: 14px;
    margin-bottom: 8px;
    overflow: hidden;
}

.month-header {
    padding: 12px 14px;
    background: linear-gradient(180deg, #2a2a2a, #181818);
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    border-bottom: 1px solid #111;
    box-shadow:
        inset 0 1px 0 rgba(255,255,255,0.08),
        inset 0 -1px 0 rgba(0,0,0,0.6);
    transition: transform 0.2s ease;
}

.month-header:active {
    transform: translateY(1px);
}

.month-title {
    font-weight: 900;
    color: #fff;
    text-transform: uppercase;
    font-size: 12px;
    letter-spacing: 1px;
}
.month-summary {
    font-size: 10px;
    color: #aaa;
    margin-top: 4px;
}
.month-actions {
    display: flex;
    align-items: center;
    gap: 15px;
}
.month-chevron {
    transition: 0.3s;
}
.month-body {
    max-height: 0;
    overflow: hidden;
    padding: 0;
    background: linear-gradient(180deg, #101010, #0b0b0b);
    border-top: 1px solid rgba(255,255,255,0.03);
    transform: translateY(-8px);
    opacity: 0;
    transition:
        max-height 0.35s ease,
        padding 0.3s ease,
        transform 0.35s cubic-bezier(0.22, 1, 0.36, 1),
        opacity 0.25s ease;
}
.month-body.open {
    max-height: 5000px;
    padding: 8px 0;
    transform: translateY(0);
    opacity: 1;
}
.btn-del-month {
    color: var(--accent);
    background: none;
    border: 1px solid var(--accent);
    border-radius: 5px;
    padding: 4px 8px;
    font-size: 10px;
    font-weight: bold;
    cursor: pointer;
}
.btn-rep-month {
    color: #000;
    background: var(--primary);
    border: none;
    border-radius: 5px;
    padding: 4px 8px;
    font-size: 10px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 4px;
}
.btn-rep-month:active {
    opacity: 0.7;
}
.clickable {
  cursor: pointer;
}

.clickable:active {
  opacity: 0.6;
}
@media print { 
    html, body { 
        height: auto !important; 
        overflow: visible !important; 
        position: static !important; 
    }
    body * { visibility: hidden; } 
    #reportView, #reportView * { visibility: visible; } 
    .no-print { display: none !important; visibility: hidden !important; } 
    #reportView { position: absolute; left: 0; top: 0; width: 100%; display: block !important; height: auto !important; } 
    .report-scroll-area { overflow: visible !important; height: auto !important; max-height: none !important; } 
    
    .report-section { 
        page-break-inside: avoid !important;
        border: 2px solid #000 !important;
        padding: 15px !important;
        margin-bottom: 20px !important;
        background: #fff !important;
    }
    
    table { page-break-inside: auto; }
    tr { page-break-inside: avoid; page-break-after: auto; }
    
    .summary-box { 
        page-break-inside: avoid !important;
        page-break-before: always !important;
        border: 3px solid #000 !important;
        padding: 20px !important;
        background: #fff !important;
    }
    
    h3 { 
        page-break-after: avoid;
        margin-top: 0 !important;
    }

    #reportView * {
        color: #000 !important;
        background: #fff !important;
        border-color: #000 !important;
        box-shadow: none !important;
        text-shadow: none !important;
    }

    table, th, td {
        border-color: #000 !important;
        background: #fff !important;
        color: #000 !important;
    }

    th {
        font-weight: bold;
        background: #f0f0f0 !important;
        color: #000 !important;
    }

    h1, h2, h3, h4, h5, h6 {
        color: #000 !important;
    }

    i, svg {
        color: #000 !important;
        fill: #000 !important;
    }

    hr {
        border: none !important;
        border-top: 2px solid #000 !important;
    }

    .summary-row {
        color: #000 !important;
        background: #fff !important;
        border-color: #000 !important;
    }

    span, div, p {
        color: #000 !important;
    }
}
@media (display-mode: standalone) {
    #mainContainer {
        width: 96vw;
        max-width: 96vw;

        margin-top: 15px;
        margin-left: auto;
        margin-right: auto;

        border-radius: 20px;
        background: var(--bg);

        height: calc(100dvh - env(safe-area-inset-bottom, 0px));
        padding-bottom: calc(40px + env(safe-area-inset-bottom, 0px));

        overflow-y: auto;
        overflow-x: hidden;
    }
}
.safe-box{
  grid-column: span 4;
  height:52px;
  border-radius:12px;
  background:linear-gradient(180deg,#2e2e2e,#161616);
  border:1px solid #444;
  box-shadow:
    inset 0 1px 2px rgba(255,255,255,.12),
    inset 0 -2px 4px rgba(0,0,0,.7),
    0 4px 6px rgba(0,0,0,.6);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  position:relative;
  cursor:pointer;
  user-select:none;
}

.safe-door{
  position:absolute;
  inset:6px;
  background:#222;
  border-radius:10px;
  transform-origin:left center;
  transition:transform .6s cubic-bezier(.4,0,.2,1);
}

.safe-door.open{
  transform:rotateY(-65deg);
}

.safe-glass{
  position:absolute;
  inset:0;
  background:linear-gradient(135deg,
    rgba(255,255,255,.18),
    rgba(255,255,255,.02));
  backdrop-filter:blur(1px);
  border-radius:10px;
}

.safe-lock{
  position:absolute;
  right:10px;
  top:50%;
  transform:translateY(-50%);
  font-size:20px;
  color:var(--accent);
}

.safe-lock.unlock i{
  animation:unlockAnim .1s ease;
}

@keyframes unlockAnim{
  0%{transform:rotate(0)}
  30%{transform:rotate(-12deg)}
  60%{transform:rotate(12deg)}
  100%{transform:rotate(0)}
}

.safe-label{
  position:relative;
  z-index:1;
  font-size:10px;
  font-weight:900;
  letter-spacing:1px;
  color:#ff4d4d;
  text-shadow:0 0 6px rgba(255,77,77,.6);
}
    </style>
</head>
<body>
<div id="passwordScreen" style="display:none; position:fixed; inset:0; z-index:99999; background:var(--bg); align-items:center; justify-content:center; flex-direction:column; padding:20px;">
    <div style="text-align:center; max-width:350px; width:100%;">
        <h1 id="passwordTitle" style="color:var(--primary); font-size:28px; margin-bottom:30px; text-transform:uppercase; font-weight:900;">RIDER TRACKER PRO</h1>
        <p id="passwordSubtitle" style="color:var(--text); font-size:14px; margin-bottom:20px; line-height:1.6;">Per accedere all'applicazione √® necessario richiedere la password nella pagina Facebook:</p>
        <a href="https://www.facebook.com/share/1AiU7ZZRjd/" target="_blank" style="color:var(--primary); font-size:12px; text-decoration:underline; display:block; margin-bottom:30px;">https://www.facebook.com/share/1AiU7ZZRjd/</a>
        <input type="password" id="passwordInput" placeholder="Password" style="width:100%; padding:15px; background:var(--input-bg); border:1px solid #444; color:#fff; border-radius:12px; margin-bottom:15px; outline:none; font-size:16px; text-align:center;" onkeypress="if(event.key==='Enter') verificaPassword()">
        <button id="passwordBtn" onclick="verificaPassword()" style="width:100%; padding:16px; background:var(--primary); color:#000; border:none; border-radius:12px; font-weight:900; font-size:14px; text-transform:uppercase; cursor:pointer;">ACCEDI</button>
        <p id="passwordError" style="color:var(--accent); font-size:12px; margin-top:15px; display:none;">Password non corretta</p>
    </div>
</div>
<div id="mainContainer" style="display:block;">

  <div class="app-title no-print"
       style="display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              width: 100%;
              margin: 14px 0 24px 0;
              line-height: 1.03;">

    <div id="appTitle" onclick="document.getElementById('modalFineMese').style.display = 'flex';"
         style="display: flex;
                align-items: center;
                font-family: sans-serif;
                font-weight: 900;
                font-size: 27px;
                letter-spacing: -0.5px;
                cursor: pointer;">

        <span style="color: var(--primary);
                     text-shadow: 0 0 15px rgba(0,204,188,0.4);">
            RIDER
        </span>

        <span style="color: #ffffff; margin-left: 5px;">
            TRACKER
        </span>

        <span style="color: var(--bg);
                     background: var(--primary);
                     padding: 2px 6px;
                     border-radius: 5px;
                     margin-left: 7px;
                     font-size: 20px;
                     font-weight: 900;">
            PRO
        </span>
    </div>

    <div style="display: flex;
                align-items: center;
                gap: 8px;
                margin-top: 6px;
                font-weight: bold;
                text-transform: uppercase;
                font-size: 9px;
                letter-spacing: 1px;">
        <span style="color: var(--dim);">VERSION 1.3</span>
        <span style="color: #444;">|</span>
        <span style="color: var(--dim);">
            ¬© 2026 by
            <a href="https://facebook.com/madmaddj"
               target="_blank"
               style="color: var(--primary);
                      text-decoration: none;
                      border-bottom: 1px solid rgba(0, 204, 188, 0.2);">
                MARCO CARBONE
            </a>
        </span>
    </div>

  </div>

<div style="display:flex; gap:10px; justify-content:center; margin-bottom:15px;">
    <button id="btnLangIT" onclick="cambiaLingua('it')" style="padding:8px 20px; border-radius:10px; border:2px solid var(--primary); background:var(--primary); color:#000; font-weight:bold; font-size:12px; cursor:pointer;">IT</button>
    <button id="btnLangEN" onclick="cambiaLingua('en')" style="padding:8px 20px; border-radius:10px; border:2px solid #444; background:transparent; color:var(--text); font-weight:bold; font-size:12px; cursor:pointer;">EN</button>
</div>

        <div class="grid no-print">
            <div class="card main"><span class="label" id="labelGrossEarned">LORDO GUADAGNATO</span><span class="val">‚Ç¨<span id="lordo">0.00</span></span></div>
            <div class="card main"><span class="label" id="labelNetEarned">NETTO GUADAGNATO</span><span class="val" id="netto">‚Ç¨0.00</span></div>
            <div class="card"><span class="label" id="labelTotalHoursWork">ORE TOT LAVORO</span><span class="val" id="ore">0.0</span></div>
        <div class="card">
  <span class="label" id="labelFuelQty">Q.T√Ä CONSUMO</span>
  <span class="val" id="cons" onclick="apriMulti('consumo')">0.0L</span>
</div>

<div class="card">
  <span class="label" id="labelAvgConsumption">MEDIA CONSUMI</span>
  <span class="val" id="kml" onclick="apriMulti('efficienza')">0.0</span>
</div>
           <div class="card"><span class="label" id="labelFuelExpense">SPESA CARBURANTE</span><span class="val" id="spesaB">‚Ç¨0.00</span></div>
            <div class="card"><span class="label" id="labelNetTarget">OBIETTIVO NETTO</span><input type="number" id="targetIn" oninput="aggiornaTarget()" placeholder="Inserisci" autocomplete="off"></div>
<div class="card"><span class="label" id="labelTaxPercent">TASSAZIONE %</span><input type="number" id="taxIn" oninput="aggiornaTax()" placeholder="Inserisci" autocomplete="off"></div>
            <div class="card"><span class="label" id="labelGrossMissing">LORDO MANCANTE</span><span class="val" id="mancante">‚Ç¨0.00</span></div>
        </div>
        <div class="progress-container no-print">
            <div class="progress-header"><span id="labelObjective">OBIETTIVO</span> <span id="perc">0%</span></div>
            <div class="progress-bar"><div id="bar"></div></div>
            <div class="dash-info"><div id="liveClock">--/--/-- 00:00:00</div><div id="mediaOraria">MEDIA: ‚Ç¨0.00/h</div></div>
        </div>

<div id="modalUnits" class="modal">
    <div class="modal-content">
        <h3 id="titleModalUnits">Seleziona Unit√† di Misura</h3>
        <div style="margin:20px 0;">
            <div style="margin-bottom:15px;">
                <div style="font-size:12px; color:var(--dim); margin-bottom:8px; text-transform:uppercase; font-weight:bold;" id="labelDistanceUnit">Distanza</div>
                <div style="display:flex; gap:8px;">
                    <button id="btnUnitKm" onclick="selezionaUnita('metric')" style="flex:1; padding:12px; border-radius:10px; border:2px solid var(--primary); background:var(--primary); color:#000; font-weight:bold;">Km</button>
                    <button id="btnUnitMiles" onclick="selezionaUnita('imperial')" style="flex:1; padding:12px; border-radius:10px; border:2px solid #444; background:transparent; color:var(--text); font-weight:bold;">Miles</button>
                </div>
            </div>
            <div>
                <div style="font-size:12px; color:var(--dim); margin-bottom:8px; text-transform:uppercase; font-weight:bold;" id="labelFuelUnit">Carburante</div>
                <div style="display:flex; gap:8px;">
                    <button id="btnUnitLiters" onclick="selezionaUnitaCarburante('metric')" style="flex:1; padding:12px; border-radius:10px; border:2px solid var(--primary); background:var(--primary); color:#000; font-weight:bold;">Litri</button>
                    <button id="btnUnitGallons" onclick="selezionaUnitaCarburante('imperial')" style="flex:1; padding:12px; border-radius:10px; border:2px solid #444; background:transparent; color:var(--text); font-weight:bold;">Galloni</button>
                </div>
            </div>
        </div>
        <button class="btn-modal btn-save" id="btnSaveUnits" onclick="confermaUnita()">Conferma</button>
    </div>
</div>

        <div id="modalSelectCarburante" class="modal no-print" style="z-index: 10000;">
    <div class="modal-content" style="border-color: var(--orange);">
        <h3 id="titleSelectFuel">SELEZIONA CARBURANTE</h3>
        <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
            <button class="btn-option" id="optFuelGas" onclick="selezionaCarburanteTradotto('benzina', 'main')">
                <span>‚õΩ</span> Benzina
            </button>
            <button class="btn-option" id="optFuelDiesel" onclick="selezionaCarburanteTradotto('diesel', 'main')">
                <span>üõ¢Ô∏è</span> Gasolio
            </button>
            <button class="btn-option" id="optFuelGpl" onclick="selezionaCarburanteTradotto('gpl', 'main')">
                <span>üîµ</span> GPL
            </button>
            <button class="btn-option" id="optFuelMethane" onclick="selezionaCarburanteTradotto('metano', 'main')">
                <span>üí®</span> Metano
            </button>
            <button class="btn-option" id="optFuelMix" onclick="selezionaCarburanteTradotto('miscela', 'main')">
                <span>üîÄ</span> Miscela
            </button>
        </div>
        <button class="btn-modal btn-close" id="btnCancelSelectFuel" onclick="document.getElementById('modalSelectCarburante').style.display='none'">ANNULLA</button>
    </div>
</div>
        <div id="modalTurno" class="modal no-print"><div class="modal-content"><h3 id="titleModalTurn">Nuovo Turno</h3><div id="dateT" class="date-row"></div>
        <div id="modalSelectMezzo" class="modal no-print" style="z-index: 10000;">
    <div class="modal-content" style="border-color: var(--primary);">
        <h3 id="titleSelectVehicle">SELEZIONA MEZZO</h3>
        <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
            <button class="btn-option" id="optVehCar" onclick="selezionaMezzoTradotto('auto')">
                <span>üöó</span> Auto
            </button>
            <button class="btn-option" id="optVehMoto" onclick="selezionaMezzoTradotto('moto')">
                <span>üõµ</span> Moto
            </button>
            <button class="btn-option" id="optVehBike" onclick="selezionaMezzoTradotto('bici')">
                <span>üö≤</span> Bici
            </button>
        </div>
        
        <button class="btn-modal btn-close" id="btnCancelSelectVehicle" onclick="document.getElementById('modalSelectMezzo').style.display='none'">ANNULLA</button>
    </div>
</div>
<div id="modalSelectCarburanteTurno" class="modal no-print" style="z-index: 10001;">
    <div class="modal-content" style="border-color: var(--orange);">
        <h3 id="titleSelectFuelTurn">SELEZIONA CARBURANTE</h3>
        <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
            <button class="btn-option" id="optFuelTurnGas" onclick="selezionaCarburanteTradotto('benzina', 'turno')">
                <span>‚õΩ</span> Benzina
            </button>
            <button class="btn-option" id="optFuelTurnDiesel" onclick="selezionaCarburanteTradotto('diesel', 'turno')">
                <span>üõ¢Ô∏è</span> Gasolio
            </button>
            <button class="btn-option" id="optFuelTurnGpl" onclick="selezionaCarburanteTradotto('gpl', 'turno')">
                <span>üîµ</span> GPL
            </button>
            <button class="btn-option" id="optFuelTurnMethane" onclick="selezionaCarburanteTradotto('metano', 'turno')">
                <span>üí®</span> Metano
            </button>
            <button class="btn-option" id="optFuelTurnMix" onclick="selezionaCarburanteTradotto('miscela', 'turno')">
                <span>üîÄ</span> Miscela
            </button>
        </div>
        <button class="btn-modal btn-close" id="btnCancelSelectFuelTurn" onclick="document.getElementById('modalSelectCarburanteTurno').style.display='none'">ANNULLA</button>
    </div>
</div>
   <input type="hidden" id="tMezzo" value="auto">
<input type="hidden" id="tCarburante" value="benzina">
<div style="display: flex; gap: 8px; margin-bottom: 10px;">
    <div class="fake-select" onclick="document.getElementById('modalSelectMezzo').style.display='flex'" style="flex: 1; margin-bottom: 0;">
        <span id="labelMezzo">üöó Auto</span>
        <i class="fas fa-chevron-down" style="color: var(--dim);"></i>
    </div>
    <div class="fake-select" onclick="document.getElementById('modalSelectCarburanteTurno').style.display='flex'" style="flex: 1; margin-bottom: 0;">
        <span id="labelCarburanteTurno">‚õΩ Benzina</span>
        <i class="fas fa-chevron-down" style="color: var(--dim);"></i>
    </div>
</div>
        <input type="number" id="tL" placeholder="Lordo (‚Ç¨)" step="0.01" autocomplete="off"><input type="number" id="tO" placeholder="Ore lavorate" step="0.1" autocomplete="off">
        <input type="number" id="tK" placeholder="Km percorsi" autocomplete="off"><input
  type="number"
  id="tC"
  placeholder="Consumo:(Litri o Kg)/100 km"
  step="0.1"
  autocomplete="off"><button class="btn-modal btn-save" id="btnSaveTurn" onclick="salvaTurno()">SALVA</button><button class="btn-modal btn-close" id="btnCancelTurn" onclick="chiudiModali()">ANNULLA</button></div></div>
     <div id="modalBenza" class="modal no-print"><div class="modal-content" style="border-color: var(--orange);"><h3 id="titleModalRefuel">Rifornimento</h3><div id="dateB" class="date-row"></div><input type="hidden" id="bTipo" value="benzina"><div class="fake-select" onclick="document.getElementById('modalSelectCarburante').style.display='flex'"><span id="labelCarburante">‚õΩ Benzina</span><i class="fas fa-chevron-down" style="color: var(--dim);"></i></div><input type="number" id="bE" placeholder="Euro spesi (‚Ç¨)" step="0.01" autocomplete="off"><input type="text" id="bP" placeholder="Prezzo (‚Ç¨/L)" inputmode="decimal" oninput="formattaPrezzo(this)" autocomplete="off"><div id="campiMiscela" style="display:none;"><input type="number" id="bPercMiscela" placeholder="% Miscela (es: 2 per 2%)" step="0.1" autocomplete="off"><input type="text" id="bPrezzoOlio" placeholder="Prezzo olio (‚Ç¨/kg)" inputmode="decimal" oninput="formattaPrezzo(this)" autocomplete="off"></div><button class="btn-modal btn-save" id="btnSaveRefuel" style="background: var(--orange);" onclick="salvaBenza()">SALVA</button><button class="btn-modal btn-close" id="btnCancelRefuel" onclick="chiudiModali()">ANNULLA</button></div></div>
    <div id="modalInizio" class="modal no-print"><div class="modal-content" style="border-color: var(--primary);"><h3 style="font-size: 16px;" id="titlePrezzoIniziale">‚õΩ ULTIMO PREZZO CARBURANTE</h3><p style="font-size: 11px; color: var(--dim); margin-bottom: 15px; text-transform: uppercase;" id="descPrezzoIniziale">Inserisci il prezzo dell'ultimo rifornimento:</p>
    <input type="text" id="pIniziale" placeholder="0.000" inputmode="decimal" oninput="formattaPrezzo(this)" style="text-align: center; font-size: 24px; color: var(--primary); font-weight: bold;"><div id="campiOlioInizio" style="display:none; margin-top:15px;"><p style="font-size: 11px; color: var(--dim); margin-bottom: 10px; text-transform: uppercase;" id="labelMixData">DATI MISCELA:</p><input type="number" id="pPercMiscelaInizio" placeholder="% Miscela (es: 2 per 2%)" step="0.1" style="margin-bottom:10px; font-size:16px; padding:12px;"><input type="text" id="pOlioInizio" placeholder="Prezzo olio (‚Ç¨/kg)" inputmode="decimal" oninput="formattaPrezzo(this)" style="font-size:16px; padding:12px;"></div><button class="btn-modal btn-save" id="btnSavePriceInit" onclick="confermaPrezzoIniziale()">SALVA E CONTINUA</button>
    <button class="btn-modal btn-close" id="btnCancelPriceInit" onclick="chiudiModali()">ANNULLA</button></div></div>
        <div id="modalConfirm" class="modal no-print"><div class="modal-content" style="border-color: var(--accent);"><h3 id="titleConfirmReset" style="color: var(--accent); font-size: 16px;">Conferma Reset</h3><p id="msgConfirmReset" style="font-size: 13px; color: var(--text); margin: 15px 0;">Vuoi azzerare tutto il database?</p><div class="confirm-buttons"><button class="btn-confirm-cancel" id="btnCancelReset" onclick="chiudiModali()">ANNULLA</button><button class="btn-confirm-ok" id="btnOkReset" style="background: var(--accent); color: white;" onclick="confermaReset()">OK</button></div></div></div>
        <div id="modalFineMese" class="modal no-print"><div class="modal-content" style="border-color: var(--primary);"><h3 id="titleEndMonth" style="font-size: 16px;">üîî FINE MESE</h3><p id="msgEndMonth" style="font-size: 13px; color: var(--text); margin: 15px 0;">Il mese √® terminato. Vuoi stampare il Report PDF delle tue attivit√†?</p><div class="confirm-buttons"><button class="btn-confirm-cancel" id="btnCloseEndMonth" onclick="chiudiModali()">CHIUDI</button><button class="btn-confirm-ok" id="btnPrintNow" style="background: var(--primary); color: #000;" onclick="stampaDirettaDaAlert()">STAMPA ORA</button></div></div></div>
        <div id="modalElimina" class="modal no-print"><div class="modal-content" style="border-color: var(--accent);"><h3 id="titleConfirmDel" style="color: var(--accent); font-size: 16px;">Conferma Eliminazione</h3><p id="msgConfirmDel" style="font-size: 13px; color: var(--text); margin: 15px 0;">Sei sicuro di voler eliminare questo elemento dallo storico?</p><div class="confirm-buttons"><button class="btn-confirm-cancel" id="btnCancelDel" onclick="chiudiModali()">ANNULLA</button><button id="btnConfermaElimina" class="btn-confirm-ok" style="background: var(--accent); color: white;">ELIMINA</button></div></div></div>
        <div id="modalBackupExport" class="modal no-print"><div class="modal-content" style="border-color: var(--primary);"><h3 id="titleExportDB" style="font-size: 16px;">üíæ ESPORTA DATABASE</h3><p id="msgExportDB" style="font-size: 13px; color: var(--text); margin: 15px 0;">Vuoi esportare un backup del database aggiornato?</p><div class="confirm-buttons"><button class="btn-confirm-cancel" id="btnNoExport" onclick="rifiutaBackup()">NO</button><button class="btn-confirm-ok" id="btnYesExport" style="background: var(--primary); color: #000;" onclick="accettaBackup()">SI</button></div></div></div>
      <div id="modalExtra" class="modal no-print"><div class="modal-content" style="border-color: var(--accent);"><h3 id="titleModalExtra">KM Extra</h3><div id="dateE" class="date-row"></div><input type="number" id="extraKmInput" placeholder="Km extra" autocomplete="off"><input type="text" id="extraDescInput" placeholder="Descrizione" autocomplete="off"><input type="number" id="extraMediaInput" placeholder="Media consumo per 100 km" step="0.1" autocomplete="off"><input type="hidden" id="extraCarburanteInput" value=""><div class="fake-select" onclick="document.getElementById('modalSelectCarburanteExtra').style.display='flex'"><span id="labelCarburanteExtra">Seleziona carburante</span><i class="fas fa-chevron-down" style="color: var(--dim);"></i></div><button class="btn-modal btn-save" id="btnSaveExtra" style="background: var(--accent);" onclick="salvaExtraKm()">SALVA</button><button class="btn-modal btn-close" id="btnCancelExtra" onclick="chiudiModali()">ANNULLA</button></div></div>
      <div id="modalSelectCarburanteExtra" class="modal no-print" style="z-index: 10002;"><div class="modal-content" style="border-color: var(--orange);"><h3 id="titleSelectFuelExtra">SELEZIONA CARBURANTE</h3><div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;"><button class="btn-option" id="optFuelExtraGas" onclick="selezionaCarburanteTradotto('benzina', 'extra')"><span>‚õΩ</span> Benzina</button><button class="btn-option" id="optFuelExtraDiesel" onclick="selezionaCarburanteTradotto('diesel', 'extra')"><span>üõ¢Ô∏è</span> Gasolio</button><button class="btn-option" id="optFuelExtraGpl" onclick="selezionaCarburanteTradotto('gpl', 'extra')"><span>üîµ</span> GPL</button><button class="btn-option" id="optFuelExtraMethane" onclick="selezionaCarburanteTradotto('metano', 'extra')"><span>üí®</span> Metano</button><button class="btn-option" id="optFuelExtraMix" onclick="selezionaCarburanteTradotto('miscela', 'extra')"><span>üîÄ</span> Miscela</button></div><button class="btn-modal btn-close" id="btnCancelSelectFuelExtra" onclick="document.getElementById('modalSelectCarburanteExtra').style.display='none'">ANNULLA</button></div></div>
        <div id="modalMulti" class="modal no-print">
  <div class="modal-content">
    <h3 id="multiTitle">DETTAGLIO</h3>
    <div id="multiBody"></div>
    <button class="btn-modal btn-close" id="btnCloseMulti" onclick="chiudiModali()">CHIUDI</button>
  </div>
</div>
        <div id="histView" class="no-print">
       <div class="hist-header"><h2 id="titleHistView" style="color:var(--primary); text-align:center;">STORICO</h2></div><div id="listaStorico"></div><div class="hist-footer" style="padding-bottom: 40px; padding-left: 15px; padding-right: 15px;"><button class="btn-modal btn-close" id="btnCloseHistView" onclick="document.getElementById('histView').style.display='none'">CHIUDI</button></div></div>
        <div id="reportView">
            <div class="report-scroll-area">
                <div class="report-header-mini"><h2 id="repMonthTitle">RIEPILOGO MESE DI ---</h2></div>
<div class="report-section" style="border: 2px solid #000; padding: 8px; margin-bottom: 20px; overflow-x: auto;"><h3 id="titleTurnDetail" style="margin-top: 0;">DETTAGLIO TURNI</h3>             
<table class="report-table"><thead><tr><th id="thDate">DATA</th><th id="thGross">LORDO</th><th id="thNet">NETTO</th><th id="thHours">ORE</th><th id="thKm">KM</th><th id="thCons">C/100</th><th id="thType">T</th><th id="thQty">QTA</th></tr></thead><tbody id="repTurniBody"></tbody></table></div>
<div class="report-section" style="border: 2px solid #000; padding: 8px; margin-bottom: 20px; overflow-x: auto;"><h3 id="titleRefuelDetail" style="margin-top: 0;">DETTAGLIO RIFORNIMENTI</h3><table class="report-table"><thead><tr><th id="thDateRef">DATA</th><th id="thTypeRef">TIPO</th><th id="thExpense">SPESA</th><th id="thPrice">PREZZO</th><th id="thQtyRef">QTA</th></tr></thead><tbody id="repBenzaBody"></tbody></table></div>
<div class="report-section" style="border: 2px solid #000; padding: 8px; margin-bottom: 20px; overflow-x: auto;"><h3 id="titleEfficiency" style="margin-top: 0;">ANALISI EFFICIENZA OPERATIVA</h3><table class="report-table"><thead><tr><th id="thPeriod">PERIODO</th><th id="thTurns">TURNI</th><th id="thKmEff">KM</th><th id="thAvg">MEDIA</th><th id="thFuel">BENZINA</th><th id="thNetEff">NETTO</th><th id="thEuroH">‚Ç¨/H</th></tr></thead><tbody id="repEfficienzaBody"></tbody></table></div>
<div id="repDettagliCarburanti"></div>
<div id="repFinalSummary"></div>
            </div>
            
            <div class="report-fixed-footer no-print">
                <div class="backup-grid">
                    <button id="btnExportBackup" class="btn-rep-uniform" style="background: var(--primary); color: #000; border: none;" onclick="salvaBackup()">
                        <i class="fas fa-file-export"></i> Esporta backup
                    </button>
                    <button id="btnImportBackup" class="btn-rep-uniform" style="background: var(--primary); color: #000; border: none;" onclick="document.getElementById('fileBackup').click()">
                        <i class="fas fa-file-import"></i> Importa backup
                    </button>
                    <input type="file" id="fileBackup" accept=".json" hidden>
                </div>
                <div class="action-grid">
                    <button id="btnPrintReport" class="btn-rep-uniform btn-grey-dark" onclick="window.print()">
                        <i class="fas fa-print"></i> Stampa Report
                    </button>
                    <button id="btnYield" class="btn-rep-uniform btn-grey-dark" onclick="apriResaView()">
                        <i class="fas fa-chart-line"></i> Resa
                    </button>
                    <button id="btnCloseReportView" class="btn-rep-uniform btn-black" onclick="document.getElementById('reportView').style.display='none'">
                        <i class="fas fa-times"></i> Chiudi
                    </button>
                </div>
            </div>
        </div>
        <div id="resaView" style="display:none; position:fixed; inset:0; z-index:8500; background:#fff; color:#000; flex-direction:column; padding:15px;">
            <h2 style="text-align:center; margin:0 0 15px 0; font-size:16px; text-transform:uppercase;">GRAFICO RESA</h2>
            <div style="flex:1; overflow-y:auto;">
                <div style="margin-bottom:20px;"><canvas id="chartOra"></canvas></div>
                <div><canvas id="chartKm"></canvas></div>
            </div>
            <button class="btn-rep-uniform btn-black" style="margin-top:15px;" onclick="chiudiResaView()"><i class="fas fa-times"></i> Chiudi</button>
        </div>
        <div class="sticky-footer no-print">
            <button class="foot-btn" id="btnFootTurn" onclick="apriModale('modalTurno', 'dateT')"><i class="fas fa-briefcase"></i>Turno</button>
            <button class="foot-btn" id="btnFootFuel" onclick="apriModale('modalBenza', 'dateB')"><i class="fas fa-gas-pump"></i>Fuel</button>
            <button class="foot-btn" id="btnFootExtra" onclick="apriModale('modalExtra', 'dateE')"><i class="fas fa-route"></i>Extra</button>
            <button class="foot-btn" id="btnFootHistory" onclick="apriStorico()"><i class="fas fa-history"></i>Storico</button>
            <button class="foot-btn" id="btnFootReport" onclick="generaReport()"><i class="fas fa-chart-bar"></i>Report</button>
            <button class="btn-full" id="btnSaveDay" onclick="salvaGiornata()">SALVA GIORNATA</button>
<div class="safe-box" onclick="toggleSafeReset()">
  <div class="safe-door" id="safeDoor">
    <div class="safe-glass"></div>
  </div>
  <div class="safe-lock" id="safeLock"><i class="fas fa-lock"></i></div>
  <div class="safe-label" id="labelResetDay">RESET GIORNATA</div>
</div>
        </div>
    </div>

<script>
let db = {
    turni: [],
    rifornimenti: [],
    extraKm: [],
    obiettivoGiorno: 140,
    obiettivoPrezzo: 0.01,
    targets: {},
    tax: 22
};

let currentLang = localStorage.getItem('app_lang') || 'it';
let unitSystem = localStorage.getItem('app_unit_system') || 'metric';

const translations = {
    it: {
        appTitle: 'RIDER TRACKER PRO V1.3',
        today: 'Oggi',
        yesterday: 'Ieri',
        month: 'Mese',
        daily: 'Giornaliero',
        totalHours: 'Tot. Ore',
        totalKm: 'Tot. Km',
        totalFuel: 'Tot. Carburante',
        gross: 'Lordo',
        net: 'Netto',
        missing: 'Mancante',
        objective: 'Obiettivo',
        hourlyAvg: 'Media Oraria',
        turn: 'Turno',
        fuel: 'Rifornimento',
        extraKm: 'Extra Km',
        history: 'Storico',
        report: 'Report',
        saveDay: 'Salva Giornata',
        resetDay: 'Reset Giornata',
        modalTurnTitle: 'Registra Turno',
        modalTurnVehicle: 'Seleziona Mezzo',
        modalTurnHours: 'Ore lavorate',
        modalTurnKm: 'Km percorsi',
        modalTurnGross: 'Guadagno lordo',
        modalTurnNet: 'Guadagno netto',
        modalTurnFuel: 'Tipo Carburante',
        modalTurnConsumption: 'Consumo:(Litri)/100 km',
        modalTurnConsumptionKg: 'Consumo:(Kg)/100 km',
        modalTurnConsumptionMiles: 'Consumo:MPG',
        modalTurnDate: 'Data',
        modalTurnSave: 'Salva Turno',
        modalTurnClose: 'Chiudi',
        modalFuelTitle: 'Rifornimento',
        modalFuelType: 'Tipo Carburante',
        modalFuelPrice: 'Prezzo ‚Ç¨/L',
        modalFuelPriceKg: 'Prezzo ‚Ç¨/Kg',
        modalFuelPriceGal: 'Prezzo ‚Ç¨/Gal',
        modalFuelLiters: 'Litri',
        modalFuelGallons: 'Galloni',
        modalFuelKg: 'Kg',
        modalFuelMixPercent: '% Miscela',
        modalFuelOilPrice: 'Prezzo Olio 2T ‚Ç¨/L',
        modalFuelSave: 'Salva Rifornimento',
        modalFuelClose: 'Chiudi',
        modalExtraTitle: 'Extra Km',
        modalExtraKm: 'Km percorsi',
        modalExtraFuel: 'Tipo Carburante',
        modalExtraSave: 'Salva Extra Km',
        modalExtraClose: 'Chiudi',
        vehicle: 'Mezzo',
        vehicleCar: 'Auto',
        vehicleMoto: 'Moto',
        vehicleScooter: 'Scooter',
        vehicleBike: 'Bici',
        vehicleVan: 'Furgone',
        vehicleMonopattino: 'Monopattino',
        fuelGasoline: 'Benzina',
        fuelDiesel: 'Diesel',
        fuelGpl: 'GPL',
        fuelMethane: 'Metano',
        fuelMix: 'Miscela',
        reportTitle: 'Report Mensile',
        reportMonth: 'Mese',
        reportYear: 'Anno',
        reportDate: 'Data',
        reportVehicle: 'Mezzo',
        reportHours: 'Ore',
        reportKm: 'Km',
        reportGross: 'Lordo',
        reportNet: 'Netto',
        reportFuel: 'Carb.',
        reportConsumption: 'Consumo',
        reportLiters: 'Litri',
        reportCost: 'Costo',
        reportSummary: 'Riepilogo',
        reportTotalHours: 'Totale Ore',
        reportTotalKm: 'Totale Km',
        reportTotalGross: 'Totale Lordo',
        reportTotalNet: 'Totale Netto',
        reportTotalFuel: 'Totale Carburante',
        reportAvgConsumption: 'Consumo Medio',
        reportKmPerLiter: 'Km/L',
        reportHourlyChart: 'GRAFICO ORARIO LORDO',
        reportKmChart: 'GRAFICO KM GIORNALIERI',
        reportBackup: 'Backup',
        reportExport: 'Esporta Dati',
        reportImport: 'Importa Dati',
        reportDeleteData: 'Elimina Dati',
        reportClose: 'Chiudi Report',
        historyTitle: 'Storico Completo',
        historyNoData: 'Nessun dato nello storico',
        historyType: 'Tipo',
        historyDeleteYear: 'Elimina Anno',
        historyClose: 'Chiudi Storico',
        confirmDelete: 'Conferma Eliminazione',
        confirmDeleteMsg: 'Sei sicuro di voler eliminare questo elemento dallo storico?',
        confirmDeleteBtn: 'Elimina',
        cancelBtn: 'Annulla',
        okBtn: 'OK',
        deleteYear: 'ELIMINA ANNO',
        deleteYearMsg: 'ATTENZIONE: Stai per eliminare TUTTI i dati dell\'anno {year}. Questa operazione canceller√† tutti i mesi e i turni di quell\'anno. √à irreversibile.',
        alertNoData: 'Nessun dato disponibile',
        alertNoDataMsg: 'Non ci sono dati per generare il report mensile.',
        alertSaveFirst: 'Salva prima la giornata',
        alertSaveFirstMsg: 'Devi salvare prima la giornata attuale per generare il report.',
        alertResetConfirm: 'Reset Giornata',
        alertResetConfirmMsg: 'Sei sicuro di voler cancellare tutti i dati della giornata in corso? Questa azione √® irreversibile.',
        initialPriceTitle: 'PREZZO',
        initialPriceDesc: 'Non hai ancora rifornimenti di {fuel}. Inserisci il prezzo dell\'ultimo rifornimento (‚Ç¨/{unit}):',
        initialPriceSave: 'Salva Prezzo',
        initialPriceClose: 'Annulla',
        passwordTitle: 'RIDER TRACKER PRO',
        passwordSubtitle: 'Inserisci la password',
        passwordPlaceholder: 'Password',
        passwordBtn: 'Accedi',
        passwordError: 'Password errata',
        unitKm: 'Km',
        unitMiles: 'Miglia',
        unitLiters: 'Litri',
        unitGallons: 'Galloni',
        modalUnitTitle: 'Seleziona Unit√† di Misura',
        modalUnitDistance: 'Distanza',
        modalUnitFuel: 'Carburante',
        modalUnitSave: 'Conferma',
        grossEarned: 'Lordo Guadagnato',
        netEarned: 'Netto Guadagnato',
        totalHoursWork: 'Ore Tot Lavoro',
        fuelQty: 'Q.t√† Consumo',
        avgConsumption: 'Media Consumi',
        fuelExpense: 'Spesa Carburante',
        netTarget: 'Obiettivo Netto',
        taxPercent: 'Tassazione %',
        grossMissing: 'Lordo Mancante',
        insertPlaceholder: 'Inserisci',
        selectFuel: 'Seleziona Carburante',
        selectVehicle: 'Seleziona Mezzo',
        cancel: 'Annulla',
        newTurn: 'Nuovo Turno',
        refuel: 'Rifornimento',
        detail: 'Dettaglio',
        close: 'Chiudi',
        currentMonth: 'Mese Corrente',
        historicalArchive: 'Archivio Storico',
        year: 'Anno',
        noDataPresent: 'Nessun dato presente',
        noDataArchive: 'Nessun dato in archivio',
        monthSummary: 'Riepilogo Mese di',
        turnDetail: 'Dettaglio Turni',
        refuelDetail: 'Dettaglio Rifornimenti',
        efficiencyAnalysis: 'Analisi Efficienza Operativa'
    },
    en: {
        appTitle: 'RIDER TRACKER PRO V1.3',
        today: 'Today',
        yesterday: 'Yesterday',
        month: 'Month',
        daily: 'Daily',
        totalHours: 'Total Hours',
        totalKm: 'Total',
        totalFuel: 'Total Fuel',
        gross: 'Gross',
        net: 'Net',
        missing: 'Missing',
        objective: 'Objective',
        hourlyAvg: 'Hourly Avg',
        turn: 'Shift',
        fuel: 'Refuel',
        extraKm: 'Extra',
        history: 'History',
        report: 'Report',
        saveDay: 'Save Day',
        resetDay: 'Reset Day',
        modalTurnTitle: 'Record Shift',
        modalTurnVehicle: 'Select Vehicle',
        modalTurnHours: 'Hours worked',
        modalTurnKm: 'Distance',
        modalTurnGross: 'Gross earnings',
        modalTurnNet: 'Net earnings',
        modalTurnFuel: 'Fuel Type',
        modalTurnConsumption: 'Consumption:(Liters)/100 km',
        modalTurnConsumptionKg: 'Consumption:(Kg)/100 km',
        modalTurnConsumptionMiles: 'Consumption:MPG',
        modalTurnDate: 'Date',
        modalTurnSave: 'Save Shift',
        modalTurnClose: 'Close',
        modalFuelTitle: 'Refuel',
        modalFuelType: 'Fuel Type',
        modalFuelPrice: 'Price ‚Ç¨/L',
        modalFuelPriceKg: 'Price ‚Ç¨/Kg',
        modalFuelPriceGal: 'Price ‚Ç¨/Gal',
        modalFuelLiters: 'Liters',
        modalFuelGallons: 'Gallons',
        modalFuelKg: 'Kg',
        modalFuelMixPercent: '% Mix',
        modalFuelOilPrice: '2T Oil Price ‚Ç¨/L',
        modalFuelSave: 'Save Refuel',
        modalFuelClose: 'Close',
        modalExtraTitle: 'Extra Distance',
        modalExtraKm: 'Distance',
        modalExtraFuel: 'Fuel Type',
        modalExtraSave: 'Save Extra',
        modalExtraClose: 'Close',
        vehicle: 'Vehicle',
        vehicleCar: 'Car',
        vehicleMoto: 'Motorcycle',
        vehicleScooter: 'Scooter',
        vehicleBike: 'Bike',
        vehicleVan: 'Van',
        vehicleMonopattino: 'E-Scooter',
        fuelGasoline: 'Gasoline',
        fuelDiesel: 'Diesel',
        fuelGpl: 'LPG',
        fuelMethane: 'Methane',
        fuelMix: 'Mix',
        reportTitle: 'Monthly Report',
        reportMonth: 'Month',
        reportYear: 'Year',
        reportDate: 'Date',
        reportVehicle: 'Vehicle',
        reportHours: 'Hours',
        reportKm: 'Distance',
        reportGross: 'Gross',
        reportNet: 'Net',
        reportFuel: 'Fuel',
        reportConsumption: 'Consumption',
        reportLiters: 'Liters',
        reportCost: 'Cost',
        reportSummary: 'Summary',
        reportTotalHours: 'Total Hours',
        reportTotalKm: 'Total Distance',
        reportTotalGross: 'Total Gross',
        reportTotalNet: 'Total Net',
        reportTotalFuel: 'Total Fuel',
        reportAvgConsumption: 'Avg Consumption',
        reportKmPerLiter: 'MPG',
        reportHourlyChart: 'HOURLY GROSS CHART',
        reportKmChart: 'DAILY DISTANCE CHART',
        reportBackup: 'Backup',
        reportExport: 'Export Data',
        reportImport: 'Import Data',
        reportDeleteData: 'Delete Data',
        reportClose: 'Close Report',
        historyTitle: 'Complete History',
        historyNoData: 'No data in history',
        historyType: 'Type',
        historyDeleteYear: 'Delete Year',
        historyClose: 'Close History',
        confirmDelete: 'Confirm Deletion',
        confirmDeleteMsg: 'Are you sure you want to delete this item from history?',
        confirmDeleteBtn: 'Delete',
        cancelBtn: 'Cancel',
        okBtn: 'OK',
        deleteYear: 'DELETE YEAR',
        deleteYearMsg: 'WARNING: You are about to delete ALL data from year {year}. This will remove all months and shifts from that year. This is irreversible.',
        alertNoData: 'No data available',
        alertNoDataMsg: 'There is no data to generate the monthly report.',
        alertSaveFirst: 'Save day first',
        alertSaveFirstMsg: 'You must save the current day first to generate the report.',
        alertResetConfirm: 'Reset Day',
        alertResetConfirmMsg: 'Are you sure you want to clear all data from the current day? This action is irreversible.',
        initialPriceTitle: 'PRICE',
        initialPriceDesc: 'You don\'t have any {fuel} refuels yet. Enter the price of the last refuel (‚Ç¨/{unit}):',
        initialPriceSave: 'Save Price',
        initialPriceClose: 'Cancel',
        passwordTitle: 'RIDER TRACKER PRO',
        passwordSubtitle: 'Enter password',
        passwordPlaceholder: 'Password',
        passwordBtn: 'Login',
        passwordError: 'Incorrect password',
        unitKm: 'mi',
        unitMiles: 'Miles',
        unitLiters: 'Liters',
        unitGallons: 'Gallons',
        modalUnitTitle: 'Select Units',
        modalUnitDistance: 'Distance',
        modalUnitFuel: 'Fuel',
        modalUnitSave: 'Confirm',
        grossEarned: 'Gross Earned',
        netEarned: 'Net Earned',
        totalHoursWork: 'Total Hours Work',
        fuelQty: 'Fuel Qty',
        avgConsumption: 'Avg Consumption',
        fuelExpense: 'Fuel Expense',
        netTarget: 'Net Target',
        taxPercent: 'Tax %',
        grossMissing: 'Gross Missing',
        insertPlaceholder: 'Insert',
        selectFuel: 'Select Fuel',
        selectVehicle: 'Select Vehicle',
        cancel: 'Cancel',
        newTurn: 'New Shift',
        refuel: 'Refuel',
        detail: 'Detail',
        close: 'Close',
        currentMonth: 'Current Month',
        historicalArchive: 'Historical Archive',
        year: 'Year',
        noDataPresent: 'No data present',
        noDataArchive: 'No data in archive',
        monthSummary: 'Month Summary',
        turnDetail: 'Shift Detail',
        refuelDetail: 'Refuel Detail',
        efficiencyAnalysis: 'Operational Efficiency Analysis'
    }
};

function t(key) {
    return translations[currentLang][key] || key;
}

function convertKmToMiles(km) {
    return unitSystem === 'imperial' ? (km * 0.621371).toFixed(2) : km;
}

function convertLitersToGallons(liters) {
    return unitSystem === 'imperial' ? (liters * 0.264172).toFixed(2) : liters;
}

function getDistanceUnit() {
    return unitSystem === 'imperial' ? 'mi' : 'km';
}

function getFuelUnit(fuelType) {
    if (fuelType === 'metano') return 'Kg';
    return unitSystem === 'imperial' ? 'Gal' : 'L';
}

function cambiaLingua(lang) {
    if (lang === 'en' && currentLang === 'it') {
        currentLang = 'en';
        localStorage.setItem('app_lang', 'en');
        mostraModaleUnita();
    } else if (lang === 'it') {
        currentLang = 'it';
        unitSystem = 'metric';
        localStorage.setItem('app_lang', 'it');
        localStorage.setItem('app_unit_system', 'metric');
        aggiornaInterfaccia();
        aggiornaPulsantiLingua();
    }
}

function mostraModaleUnita() {
    document.getElementById('titleModalUnits').innerText = t('modalUnitTitle');
    document.getElementById('labelDistanceUnit').innerText = t('modalUnitDistance');
    document.getElementById('labelFuelUnit').innerText = t('modalUnitFuel');
    document.getElementById('btnSaveUnits').innerText = t('modalUnitSave');
    document.getElementById('modalUnits').style.display = 'flex';
}

function selezionaUnita(system) {
    unitSystem = system;
    const btnKm = document.getElementById('btnUnitKm');
    const btnMiles = document.getElementById('btnUnitMiles');
    if (system === 'metric') {
        btnKm.style.background = 'var(--primary)';
        btnKm.style.borderColor = 'var(--primary)';
        btnKm.style.color = '#000';
        btnMiles.style.background = 'transparent';
        btnMiles.style.borderColor = '#444';
        btnMiles.style.color = 'var(--text)';
    } else {
        btnMiles.style.background = 'var(--primary)';
        btnMiles.style.borderColor = 'var(--primary)';
        btnMiles.style.color = '#000';
        btnKm.style.background = 'transparent';
        btnKm.style.borderColor = '#444';
        btnKm.style.color = 'var(--text)';
    }
}

function selezionaUnitaCarburante(system) {
    const btnLiters = document.getElementById('btnUnitLiters');
    const btnGallons = document.getElementById('btnUnitGallons');
    if (system === 'metric') {
        btnLiters.style.background = 'var(--primary)';
        btnLiters.style.borderColor = 'var(--primary)';
        btnLiters.style.color = '#000';
        btnGallons.style.background = 'transparent';
        btnGallons.style.borderColor = '#444';
        btnGallons.style.color = 'var(--text)';
    } else {
        btnGallons.style.background = 'var(--primary)';
        btnGallons.style.borderColor = 'var(--primary)';
        btnGallons.style.color = '#000';
        btnLiters.style.background = 'transparent';
        btnLiters.style.borderColor = '#444';
        btnLiters.style.color = 'var(--text)';
    }
}

function confermaUnita() {
    localStorage.setItem('app_unit_system', unitSystem);
    document.getElementById('modalUnits').style.display = 'none';
    aggiornaInterfaccia();
    aggiornaPulsantiLingua();
}

function aggiornaPulsantiLingua() {
    const btnIT = document.getElementById('btnLangIT');
    const btnEN = document.getElementById('btnLangEN');
    if (currentLang === 'it') {
        btnIT.style.background = 'var(--primary)';
        btnIT.style.borderColor = 'var(--primary)';
        btnIT.style.color = '#000';
        btnEN.style.background = 'transparent';
        btnEN.style.borderColor = '#444';
        btnEN.style.color = 'var(--text)';
    } else {
        btnEN.style.background = 'var(--primary)';
        btnEN.style.borderColor = 'var(--primary)';
        btnEN.style.color = '#000';
        btnIT.style.background = 'transparent';
        btnIT.style.borderColor = '#444';
        btnIT.style.color = 'var(--text)';
    }
}

function aggiornaInterfaccia() {
    document.getElementById('htmlRoot').lang = currentLang;
    document.getElementById('appTitle').innerText = t('appTitle');
    
    const labels = document.querySelectorAll('.label');
    if (labels[0]) labels[0].innerText = t('grossEarned').toUpperCase();
    if (labels[1]) labels[1].innerText = t('netEarned').toUpperCase();
    if (labels[2]) labels[2].innerText = t('totalHoursWork').toUpperCase();
    if (labels[3]) labels[3].innerText = t('fuelQty').toUpperCase();
    if (labels[4]) labels[4].innerText = t('avgConsumption').toUpperCase();
    if (labels[5]) labels[5].innerText = t('fuelExpense').toUpperCase();
    if (labels[6]) labels[6].innerText = t('netTarget').toUpperCase();
    if (labels[7]) labels[7].innerText = t('taxPercent').toUpperCase();
    if (labels[8]) labels[8].innerText = t('grossMissing').toUpperCase();
    
    const objLabel = document.getElementById('labelObjective');
    if (objLabel) objLabel.innerText = t('objective').toUpperCase();
    
    document.getElementById('targetIn').placeholder = t('insertPlaceholder');
    document.getElementById('taxIn').placeholder = t('insertPlaceholder');
    
    const footBtns = document.querySelectorAll('.foot-btn');
    if (footBtns[0]) footBtns[0].innerHTML = '<i class="fas fa-briefcase"></i>' + t('turn');
    if (footBtns[1]) footBtns[1].innerHTML = '<i class="fas fa-gas-pump"></i>' + t('fuel');
    if (footBtns[2]) footBtns[2].innerHTML = '<i class="fas fa-route"></i>' + t('extraKm');
    if (footBtns[3]) footBtns[3].innerHTML = '<i class="fas fa-history"></i>' + t('history');
    if (footBtns[4]) footBtns[4].innerHTML = '<i class="fas fa-chart-bar"></i>' + t('report');
    
    const btnSave = document.querySelector('.btn-full');
    if (btnSave) btnSave.innerText = t('saveDay').toUpperCase();
    
    const btnReset = document.querySelector('.btn-reset-soft');
    if (btnReset) btnReset.innerText = t('resetDay').toUpperCase();
    
    aggiornaModaliTradotti();
    ricalcolaTutto();
    
    document.getElementById('passwordTitle').innerText = t('passwordTitle');
    document.getElementById('passwordSubtitle').innerText = t('passwordSubtitle');
    document.getElementById('passwordInput').placeholder = t('passwordPlaceholder');
    document.getElementById('passwordBtn').innerText = t('passwordBtn');
}

function aggiornaModaliTradotti() {
    document.getElementById('titleSelectFuel').innerText = t('selectFuel').toUpperCase();
    document.getElementById('titleModalTurn').innerText = t('modalTurnTitle');
    document.getElementById('titleSelectVehicle').innerText = t('selectVehicle').toUpperCase();
    document.getElementById('titleSelectFuelTurn').innerText = t('selectFuel').toUpperCase();
    document.getElementById('titleModalRefuel').innerText = t('modalFuelTitle');
    document.getElementById('titleModalExtra').innerText = t('modalExtraTitle');
    document.getElementById('titleSelectFuelExtra').innerText = t('selectFuel').toUpperCase();
    document.getElementById('multiTitle').innerText = t('detail').toUpperCase();
    document.getElementById('titleHistView').innerText = t('history').toUpperCase();
    
    document.getElementById('btnCancelSelectFuel').innerText = t('cancel').toUpperCase();
    document.getElementById('btnCancelSelectVehicle').innerText = t('cancel').toUpperCase();
    document.getElementById('btnCancelSelectFuelTurn').innerText = t('cancel').toUpperCase();
    document.getElementById('btnSaveTurn').innerText = t('modalTurnSave').toUpperCase();
    document.getElementById('btnCancelTurn').innerText = t('modalTurnClose').toUpperCase();
    document.getElementById('btnSaveRefuel').innerText = t('modalFuelSave').toUpperCase();
    document.getElementById('btnCancelRefuel').innerText = t('modalFuelClose').toUpperCase();
    document.getElementById('btnSaveExtra').innerText = t('modalExtraSave').toUpperCase();
    document.getElementById('btnCancelExtra').innerText = t('modalExtraClose').toUpperCase();
    document.getElementById('btnCancelSelectFuelExtra').innerText = t('cancel').toUpperCase();
    document.getElementById('btnCloseMulti').innerText = t('close').toUpperCase();
    document.getElementById('btnCloseHistView').innerText = t('close').toUpperCase();
    
    document.getElementById('labelMezzo').innerText = getIconaCarburante('benzina') + ' ' + t('vehicleCar');
    document.getElementById('labelCarburanteTurno').innerText = getIconaCarburante('benzina') + ' ' + t('fuelGasoline');
    document.getElementById('labelCarburante').innerText = getIconaCarburante('benzina') + ' ' + t('fuelGasoline');
    document.getElementById('labelCarburanteExtra').innerText = currentLang === 'it' ? 'Seleziona carburante' : 'Select fuel';
    
    document.getElementById('tL').placeholder = currentLang === 'it' ? 'Lordo (‚Ç¨)' : 'Gross (‚Ç¨)';
    document.getElementById('tO').placeholder = t('modalTurnHours');
    document.getElementById('tK').placeholder = t('modalTurnKm');
    
    const tC = document.getElementById('tC');
    if (document.getElementById('tCarburante').value === 'metano') {
        tC.placeholder = t('modalTurnConsumptionKg');
    } else {
        tC.placeholder = unitSystem === 'imperial' ? t('modalTurnConsumptionMiles') : t('modalTurnConsumption');
    }
    
    document.getElementById('bE').placeholder = currentLang === 'it' ? 'Euro spesi (‚Ç¨)' : 'Amount spent (‚Ç¨)';
    const prezzoRif = document.getElementById('bP');
    if (document.getElementById('bTipo').value === 'metano') {
        prezzoRif.placeholder = t('modalFuelPriceKg');
    } else {
        prezzoRif.placeholder = unitSystem === 'imperial' ? t('modalFuelPriceGal') : t('modalFuelPrice');
    }
    
    document.getElementById('bPercMiscela').placeholder = currentLang === 'it' ? '% Miscela (es: 2 per 2%)' : '% Mix (e.g.: 2 for 2%)';
    document.getElementById('bPrezzoOlio').placeholder = currentLang === 'it' ? 'Prezzo olio (‚Ç¨/kg)' : '2T oil price (‚Ç¨/kg)';
    
    document.getElementById('extraKmInput').placeholder = currentLang === 'it' ? 'Km extra' : 'Extra distance';
    document.getElementById('extraDescInput').placeholder = currentLang === 'it' ? 'Descrizione' : 'Description';
    document.getElementById('extraMediaInput').placeholder = currentLang === 'it' ? 'Media consumo per 100 km' : 'Avg consumption per 100 ' + getDistanceUnit();
    
    const vehTexts = {
        optVehCar: t('vehicleCar'),
        optVehMoto: t('vehicleMoto'),
        optVehBike: t('vehicleBike')
    };
    Object.keys(vehTexts).forEach(id => {
        const btn = document.getElementById(id);
        if (btn) {
            const icon = btn.querySelector('span').outerHTML;
            btn.innerHTML = icon + ' ' + vehTexts[id];
        }
    });
    
    const fuelIcons = {'Gas': '‚õΩ', 'Diesel': 'üõ¢Ô∏è', 'Gpl': 'üîµ', 'Methane': 'üí®', 'Mix': 'üîÄ'};
    ['', 'Turn', 'Extra'].forEach(suffix => {
        Object.keys(fuelIcons).forEach(fuel => {
            const btn = document.getElementById('optFuel' + suffix + fuel);
            if (btn) btn.innerHTML = '<span>' + fuelIcons[fuel] + '</span> ' + t('fuel' + fuel);
        });
    });
    
    if (document.getElementById('thDate')) {
        document.getElementById('thDate').innerText = t('reportDate').toUpperCase();
        document.getElementById('thGross').innerText = t('reportGross').toUpperCase();
        document.getElementById('thNet').innerText = t('reportNet').toUpperCase();
        document.getElementById('thHours').innerText = t('reportHours').toUpperCase();
        document.getElementById('thKm').innerText = t('reportKm').toUpperCase();
        document.getElementById('thCons').innerText = t('reportConsumption').substring(0,5).toUpperCase();
        document.getElementById('thType').innerText = 'T';
        document.getElementById('thQty').innerText = 'QTA';
    }
    
    if (document.getElementById('thDateRef')) {
        document.getElementById('thDateRef').innerText = t('reportDate').toUpperCase();
        document.getElementById('thTypeRef').innerText = t('reportFuel').toUpperCase();
        document.getElementById('thExpense').innerText = t('reportCost').toUpperCase();
        document.getElementById('thPrice').innerText = currentLang === 'it' ? 'PREZZO' : 'PRICE';
        document.getElementById('thQtyRef').innerText = 'QTA';
    }
    
    if (document.getElementById('thPeriod')) {
        document.getElementById('thPeriod').innerText = currentLang === 'it' ? 'PERIODO' : 'PERIOD';
        document.getElementById('thTurns').innerText = currentLang === 'it' ? 'TURNI' : 'SHIFTS';
        document.getElementById('thKmEff').innerText = getDistanceUnit().toUpperCase();
        document.getElementById('thAvg').innerText = currentLang === 'it' ? 'MEDIA' : 'AVG';
        document.getElementById('thFuel').innerText = currentLang === 'it' ? 'BENZINA' : 'FUEL';
        document.getElementById('thNetEff').innerText = t('reportNet').toUpperCase();
        document.getElementById('thEuroH').innerText = '‚Ç¨/H';
    }
    
    document.getElementById('titleTurnDetail').innerText = t('turnDetail').toUpperCase();
    document.getElementById('titleRefuelDetail').innerText = t('refuelDetail').toUpperCase();
    document.getElementById('titleEfficiency').innerText = t('efficiencyAnalysis').toUpperCase();
    
    document.getElementById('btnExportBackup').innerHTML = '<i class="fas fa-file-export"></i> ' + (currentLang === 'it' ? 'Esporta backup' : 'Export backup');
    document.getElementById('btnImportBackup').innerHTML = '<i class="fas fa-file-import"></i> ' + (currentLang === 'it' ? 'Importa backup' : 'Import backup');
    document.getElementById('btnPrintReport').innerHTML = '<i class="fas fa-print"></i> ' + (currentLang === 'it' ? 'Stampa Report' : 'Print Report');
    document.getElementById('btnYield').innerHTML = '<i class="fas fa-chart-line"></i> ' + (currentLang === 'it' ? 'Resa' : 'Yield');
    document.getElementById('btnCloseReportView').innerHTML = '<i class="fas fa-times"></i> ' + t('close');
    
    document.getElementById('titleConfirmReset').innerText = currentLang === 'it' ? 'Conferma Reset' : 'Confirm Reset';
    document.getElementById('msgConfirmReset').innerText = currentLang === 'it' ? 'Vuoi azzerare tutto il database?' : 'Do you want to reset the entire database?';
    document.getElementById('btnCancelReset').innerText = t('cancel').toUpperCase();
    document.getElementById('btnOkReset').innerText = t('okBtn').toUpperCase();
    
    document.getElementById('titleEndMonth').innerText = currentLang === 'it' ? 'üîî FINE MESE' : 'üîî END OF MONTH';
    document.getElementById('msgEndMonth').innerText = currentLang === 'it' ? 'Il mese √® terminato. Vuoi stampare il Report PDF delle tue attivit√†?' : 'The month has ended. Do you want to print the PDF Report of your activities?';
    document.getElementById('btnCloseEndMonth').innerText = currentLang === 'it' ? 'CHIUDI' : 'CLOSE';
    document.getElementById('btnPrintNow').innerText = currentLang === 'it' ? 'STAMPA ORA' : 'PRINT NOW';
    
    document.getElementById('titleConfirmDel').innerText = t('confirmDelete');
    document.getElementById('msgConfirmDel').innerText = t('confirmDeleteMsg');
    document.getElementById('btnCancelDel').innerText = t('cancel').toUpperCase();
    
    document.getElementById('titleExportDB').innerText = currentLang === 'it' ? 'üíæ ESPORTA DATABASE' : 'üíæ EXPORT DATABASE';
    document.getElementById('msgExportDB').innerText = currentLang === 'it' ? 'Vuoi esportare un backup del database aggiornato?' : 'Do you want to export an updated database backup?';
    document.getElementById('btnNoExport').innerText = currentLang === 'it' ? 'NO' : 'NO';
    document.getElementById('btnYesExport').innerText = currentLang === 'it' ? 'SI' : 'YES';
    
    const labelMix = document.getElementById('labelMixData');
    if (labelMix) labelMix.innerText = currentLang === 'it' ? 'DATI MISCELA:' : 'MIX DATA:';
    
    document.getElementById('btnSavePriceInit').innerText = currentLang === 'it' ? 'SALVA E CONTINUA' : 'SAVE AND CONTINUE';
    document.getElementById('btnCancelPriceInit').innerText = t('cancel').toUpperCase();
    
    const labelResetDay = document.getElementById('labelResetDay');
    if (labelResetDay) labelResetDay.innerText = t('resetDay').toUpperCase();
}

function selezionaMezzoTradotto(valore) {
    const icone = {'auto': 'üöó', 'moto': 'üõµ', 'bici': 'üö≤'};
    const nomi = {'auto': t('vehicleCar'), 'moto': t('vehicleMoto'), 'bici': t('vehicleBike')};
    const testo = icone[valore] + ' ' + nomi[valore];
    selezionaMezzo(valore, testo);
}

function selezionaCarburanteTradotto(tipo, contesto) {
    const icone = getIconaCarburante(tipo);
    const nome = getNomeCarburante(tipo);
    const testo = icone + ' ' + nome;
    
    if (contesto === 'turno') {
        selezionaCarburanteTurno(tipo, testo);
    } else if (contesto === 'extra') {
        selezionaCarburanteExtra(tipo, testo);
    } else {
        selezionaCarburante(tipo, testo);
    }
}

let oggi = 0, ieri = 0, mese = 0, giornaliero = 0;
let oreLavorate = 0, kmPercorsi = 0, guadagnoLordo = 0, guadagnoNetto = 0, totCarburante = 0;
let mezzoSelezionato = '';
let tipoCarburantePrezzoIniziale = '';
let annoDaEliminare = '';

function caricaDB() {
    const salvato = localStorage.getItem('riderDB');
    if (salvato) {
        const parsed = JSON.parse(salvato);
        db = { ...db, ...parsed };
        
        if (!db.targets) db.targets = {};
        if (typeof db.tax === 'undefined') db.tax = 22;
        if (!db.extraKm) db.extraKm = [];
    }
}

function salvaDB() {
    localStorage.setItem('riderDB', JSON.stringify(db));
}

function calcola() {
    const f = `${(new Date().getMonth() + 1).toString().padStart(2, '0')}/${new Date().getFullYear()}`;
    const targ = db.targets[f] !== undefined && db.targets[f] !== null ? db.targets[f] : db.obiettivoGiorno;
    const taxVal = (db.tax !== undefined && db.tax !== null) ? db.tax : 22;
    
    const filteredTurni = db.turni.filter(t => t.data.endsWith(f));
    
    let sommaOre = 0, sommaKm = 0, sommaLordo = 0, costoBCarb = 0, sommaTasse = 0;
    filteredTurni.forEach(t => {
        sommaOre += t.ore || 0;
        sommaKm += t.km || 0;
        sommaLordo += t.lordo || 0;
        
        let tasse = (t.lordo || 0) * (taxVal / 100);
        sommaTasse += tasse;
        
        const isBici = (t.mezzo === 'bici');
        if (!isBici) {
            const tipoCarb = t.tipoCarburante || 'benzina';
            const quantita = (t.km || 0) * ((t.cons || 0) / 100);
            let costoCarb = quantita * (t.prezzo || 0);
            
            if (tipoCarb === 'miscela' && t.percMiscela && t.prezzoOlio) {
                const kgOlio = quantita * (t.percMiscela / 100);
                costoCarb += kgOlio * t.prezzoOlio;
            }
            
            costoBCarb += costoCarb;
        }
    });
    
    let guadagnoNetto = sommaLordo - sommaTasse - costoBCarb;
    let mancante = Math.max(0, targ - sommaLordo);
    let perc = targ > 0 ? Math.min(100, (sommaLordo / targ) * 100) : 0;
    
    document.getElementById('lordo').innerText = sommaLordo.toFixed(2);
    document.getElementById('netto').innerText = '‚Ç¨' + guadagnoNetto.toFixed(2);
    document.getElementById('ore').innerText = sommaOre.toFixed(1);
    document.getElementById('spesaB').innerText = '‚Ç¨' + costoBCarb.toFixed(2);
    document.getElementById('mancante').innerText = '‚Ç¨' + mancante.toFixed(2);
    document.getElementById('bar').style.width = perc.toFixed(0) + '%';
    document.getElementById('perc').innerText = perc.toFixed(0) + '%';
    
    let totCarb = 0, totKm = sommaKm;
    const tipiCarb = {};
    filteredTurni.forEach(t => {
        if (t.mezzo === 'bici') return;
        const tipoCarb = t.tipoCarburante || 'benzina';
        const quantita = (t.km || 0) * ((t.cons || 0) / 100);
        if (!tipiCarb[tipoCarb]) tipiCarb[tipoCarb] = 0;
        tipiCarb[tipoCarb] += quantita;
        totCarb += quantita;
    });
    
    const unita = getFuelUnit('benzina');
    document.getElementById('cons').innerText = totCarb.toFixed(1) + unita;
    
    let mediaKmL = totCarb > 0 ? (totKm / totCarb).toFixed(1) : '0.0';
    document.getElementById('kml').innerText = mediaKmL + ' km/' + unita;
    
    let mediaOraria = sommaOre > 0 ? (guadagnoNetto / sommaOre).toFixed(2) : '0.00';
    document.getElementById('mediaOraria').innerText = (currentLang === 'it' ? 'MEDIA' : 'AVG') + ': ‚Ç¨' + mediaOraria + '/h';
    
    document.getElementById('targetIn').value = (db.targets[f] !== undefined && db.targets[f] !== null) ? db.targets[f] : '';
    document.getElementById('taxIn').value = (db.tax !== undefined && db.tax !== null) ? db.tax : '';
}

function ricalcolaTutto() {
    calcola();
}

function startClock() {
    setInterval(() => {
        const now = new Date();
        const dateStr = now.toLocaleDateString('it-IT');
        const timeStr = now.toLocaleTimeString('it-IT');
        document.getElementById('liveClock').innerText = dateStr + ' ' + timeStr;
    }, 1000);
}

function gestisciTastiera() {
    const inputs = document.querySelectorAll('input[type="number"]');
    inputs.forEach(input => {
        input.addEventListener('focus', () => {
            setTimeout(() => {
                window.scrollTo(0, input.offsetTop - 100);
            }, 300);
        });
    });
}

function checkFineMese() {
    const now = new Date();
    const ultimoGiorno = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
    if (now.getDate() === ultimoGiorno) {
        const lastCheck = localStorage.getItem('last_month_check');
        const currentCheck = `${now.getMonth()}-${now.getFullYear()}`;
        if (lastCheck !== currentCheck) {
            setTimeout(() => {
                document.getElementById('modalFineMese').style.display = 'flex';
            }, 2000);
            localStorage.setItem('last_month_check', currentCheck);
        }
    }
}

function stampaDirettaDaAlert() {
    chiudiModali();
    generaReport();
    setTimeout(() => {
        window.print();
    }, 500);
}

function chiudiModali() {
    document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
}

function apriModale(id, p) {
    chiudiModali();
    const n = new Date();
    const d = Array.from({length: 31}, (_, i) => `<option value="${i+1}" ${n.getDate() === i+1 ? 'selected' : ''}>${i+1}</option>`).join('');
    const m = Array.from({length: 12}, (_, i) => `<option value="${i+1}" ${n.getMonth() === i ? 'selected' : ''}>${i+1}</option>`).join('');
    const y = Array.from({length: 3}, (_, i) => {
        const yr = n.getFullYear() - i;
        return `<option value="${yr}" ${i === 0 ? 'selected' : ''}>${yr}</option>`;
    }).join('');
    document.getElementById(p).innerHTML = `<select id="${p}D">${d}</select><select id="${p}M">${m}</select><select id="${p}Y">${y}</select>`;
    
    if (id === 'modalTurno') {
        const ultimoCarb = localStorage.getItem('ultimo_carburante_turno') || 'benzina';
        const ultimoLabel = localStorage.getItem('ultimo_carburante_turno_label') || getIconaCarburante('benzina') + ' ' + t('fuelGasoline');
        document.getElementById('tCarburante').value = ultimoCarb;
        document.getElementById('labelCarburanteTurno').innerText = ultimoLabel;
        
        const campoConsumo = document.getElementById('tC');
        if (ultimoCarb === 'metano') {
            campoConsumo.placeholder = t('modalTurnConsumptionKg');
        } else {
            campoConsumo.placeholder = unitSystem === 'imperial' ? t('modalTurnConsumptionMiles') : t('modalTurnConsumption');
        }
    }

    if (id === 'modalExtra') {
        document.getElementById('extraCarburanteInput').value = 'benzina';
        document.getElementById('labelCarburanteExtra').innerText = getIconaCarburante('benzina') + ' ' + t('fuelGasoline');
    }
    
    document.getElementById(id).style.display = 'flex';
}

function apriStorico() {
    const view = document.getElementById('histView');
    const lista = document.getElementById('listaStorico');
    lista.innerHTML = '';
    
    view.querySelector('h2').innerText = t('historyTitle');
    view.querySelector('.btn-modal').innerText = t('historyClose').toUpperCase();
    
    const tutti = [
        ...db.turni.map(t => ({...t, tipo: 'T'})),
        ...db.rifornimenti.map(r => ({...r, tipo: 'B', tipo_fuel: r.tipo || 'benzina'})),
        ...(db.extraKm || []).map(e => ({...e, tipo: 'E'}))
    ].sort((a, b) => b.id - a.id);

    const now = new Date();
    const meseCorrenteKey = `${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getFullYear()}`;

    let htmlCorrente = "";
    let gruppiPassati = {};
    let ordineMesi = [];
    let nettoTotMese = 0, oreTotMese = 0;

    db.turni.forEach(t => {
        let tKey = t.data.substring(3);
        if (tKey === meseCorrenteKey) {
            let litri = t.km * (t.cons / 100);
            let costoB = litri * (t.prezzo || 0);
            let tasse = t.lordo * (db.tax / 100);
            nettoTotMese += (t.lordo - tasse - costoB);
            oreTotMese += t.ore;
        }
    });

    let mediaOraMese = oreTotMese > 0 ? nettoTotMese / oreTotMese : 0;

    tutti.forEach(i => {
        let dataKey = i.data.substring(3);
        let htmlItem = generaHtmlItem(i, mediaOraMese);

        if (dataKey === meseCorrenteKey) {
            htmlCorrente += htmlItem;
        } else {
            if (!gruppiPassati[dataKey]) {
                gruppiPassati[dataKey] = { items: [], lordo: 0, netto: 0, ore: 0 };
                ordineMesi.push(dataKey);
            }
            gruppiPassati[dataKey].items.push(htmlItem);
            
            if (i.tipo === 'T') {
                let litri = i.km * (i.cons / 100);
                let tasse = i.lordo * (db.tax / 100);
                let costoB = litri * (i.prezzo || 0);
                gruppiPassati[dataKey].lordo += i.lordo;
                gruppiPassati[dataKey].netto += (i.lordo - tasse - costoB);
                gruppiPassati[dataKey].ore += i.ore;
            }
        }
    });

    let htmlFinale = "";

    if (htmlCorrente) {
        htmlFinale += `<div style="margin-bottom:20px;">
            <div style="font-size:11px; color:var(--primary); font-weight:bold; padding:5px; border-bottom:1px solid #333; margin-bottom:10px; letter-spacing:1px;">
                ${t('currentMonth').toUpperCase()} (${meseCorrenteKey})
            </div>
            ${htmlCorrente}
        </div>`;
    } else if (tutti.length === 0) {
        htmlFinale = "<div style='padding:20px; text-align:center; color:#666;'>" + t('noDataPresent') + "</div>";
    }

    ordineMesi = [...new Set(ordineMesi)];
    let storicoPerAnni = {};
    ordineMesi.forEach(key => {
        let anno = key.split('/')[1];
        if (!storicoPerAnni[anno]) storicoPerAnni[anno] = [];
        storicoPerAnni[anno].push(key);
    });

    let anniSorted = Object.keys(storicoPerAnni).sort((a, b) => b - a);

    htmlFinale += `
    <div class="month-group" style="margin-top: 20px; border-color: var(--dim);">
      <div class="month-header" onclick="toggleMese('ARCHIVIO_ROOT')">
    <div style="display:flex; align-items:center; gap:8px;">
        <i class="fas fa-archive" style="color: var(--dim); font-size:14px;"></i>
        <div class="month-title">${t('historicalArchive').toUpperCase()}</div>
    </div>
    <i class="fas fa-chevron-down month-chevron" id="chev_ARCHIVIO_ROOT" style="color:var(--dim);"></i>
</div>
        <div class="month-body" id="body_ARCHIVIO_ROOT" style="padding: 10px 5px;">`;

    if (anniSorted.length > 0) {
        anniSorted.forEach(anno => {
            htmlFinale += `
            <div class="month-group" style="margin-bottom: 8px; border-color: #444;">
                <div class="month-header" onclick="toggleMese('YEAR_${anno}')" style="background: #2a2a2a;">
                    <div>
                        <div class="month-title" style="color: #ccc;">${t('year').toUpperCase()} ${anno}</div>
                    </div>
                    <div class="month-actions">
                        <button class="btn-del-month" onclick="event.stopPropagation(); confermaEliminaAnno('${anno}')">
                            <i class="fas fa-trash"></i> ${t('year').toUpperCase()}
                        </button>
                        <i class="fas fa-chevron-down month-chevron" id="chev_YEAR_${anno}"></i>
                    </div>
                </div>
                <div class="month-body" id="body_YEAR_${anno}" style="padding: 8px 0;">`;

            storicoPerAnni[anno].forEach(key => {
                let gruppo = gruppiPassati[key];
                let nomeMese = getNomeMese(key);
                let idUnivoco = key.replace('/', '_');

                htmlFinale += `
                <div class="month-group" style="width: 96%; margin: 0 auto 10px auto;">
                    <div class="month-header" onclick="toggleMese('${idUnivoco}')">
                        <div>
                            <div class="month-title">${nomeMese}</div>
                            <div class="month-summary">
                                L: ‚Ç¨${gruppo.lordo.toFixed(0)} | N: ‚Ç¨${gruppo.netto.toFixed(0)} | ${gruppo.ore.toFixed(1)}h
                            </div>
                        </div>
                      <div class="month-actions">
                            <button class="btn-rep-month" onclick="event.stopPropagation(); apriReport('${key}')">
                                <i class="fas fa-file-alt"></i>
                            </button>
                            <button class="btn-del-month" onclick="event.stopPropagation(); confermaEliminaMese('${key}')">
                                <i class="fas fa-trash"></i>
                            </button>
                            <i class="fas fa-chevron-down month-chevron" id="chev_${idUnivoco}"></i>
                        </div>
                    </div>
                    <div class="month-body" id="body_${idUnivoco}">
                        ${gruppo.items.join('')}
                    </div>
                </div>`;
            });
            htmlFinale += `</div></div>`;
        });
    } else {
        htmlFinale += `<div style="padding:20px; text-align:center; color:#555; font-style:italic; font-size:13px;">${t('noDataArchive')}</div>`;
    }

    htmlFinale += `</div></div>`;

    document.getElementById('listaStorico').innerHTML = htmlFinale;
    document.getElementById('histView').style.display = 'flex';
}

function generaHtmlItem(i, mediaOraMese) {
    let color, label, sub, val, icon;
    if (i.tipo === 'T') {
        icon = 'fa-wallet';
        color = 'var(--primary)';
        
        const tipoCarb = i.tipoCarburante || 'benzina';
        const nomeCarb = getNomeCarburante(tipoCarb);
        const iconaCarb = getIconaCarburante(tipoCarb);
        
        label = `${t('turn').toUpperCase()} ${iconaCarb} ${nomeCarb.toUpperCase()}`;
        
        const unita = getUnitaCarburante(tipoCarb);
        const quantita = i.km * (i.cons / 100);
        let costoCarburante = quantita * (i.prezzo || 0);
        
        if (tipoCarb === 'miscela' && i.percMiscela && i.prezzoOlio) {
            const kgOlio = quantita * (i.percMiscela / 100);
            costoCarburante += kgOlio * i.prezzoOlio;
        }
        
        let tasseTurno = i.lordo * (db.tax / 100);
        let nettoTurno = i.lordo - tasseTurno - costoCarburante;
        let resaTurno = i.ore > 0 ? nettoTurno / i.ore : 0;
        let coloreNetto = 'var(--accent)';
        if (resaTurno >= mediaOraMese) coloreNetto = 'var(--primary)';
        else if (resaTurno >= mediaOraMese * 0.8) coloreNetto = 'var(--orange)';
        
        val = `<span style="font-size:14px;">L: ‚Ç¨${i.lordo.toFixed(2)}<span style="opacity:0.4; padding:0 6px;">|</span>N: <span style="color:${coloreNetto}; font-weight:900;">‚Ç¨${nettoTurno.toFixed(2)}</span></span>`;
        
        let kmlSub = i.cons > 0 ? (100 / i.cons).toFixed(1) : '0.0';
        sub = `${i.km}km | ${i.ore}h | ${currentLang === 'it' ? 'Cons.' : 'Cons.'} ${i.cons}/100 (${kmlSub} km/${unita})<br>${quantita.toFixed(2)}${unita} | ${currentLang === 'it' ? 'Prezzo' : 'Price'}: ‚Ç¨${(i.prezzo || 0).toFixed(3)}/${unita}`;
        
        if (tipoCarb === 'miscela' && i.percMiscela) {
            const kgOlio = quantita * (i.percMiscela / 100);
            sub += `<br>Miscela ${i.percMiscela}% | Olio: ${kgOlio.toFixed(2)}kg @ ‚Ç¨${i.prezzoOlio.toFixed(2)}/kg`;
        }
        
    } else if (i.tipo === 'B') {
        icon = 'fa-gas-pump';
        color = 'var(--orange)';
        
        const tipoCarb = i.tipo_fuel || i.tipo || 'benzina';
        const unita = getUnitaCarburante(tipoCarb);
        const nomeCarb = getNomeCarburante(tipoCarb);
        const iconaCarb = getIconaCarburante(tipoCarb);
        
        label = nomeCarb.toUpperCase();
        
        if (i.euro > 0) {
            val = `‚Ç¨${i.euro.toFixed(2)}`;
            const quantitaBase = (i.euro / i.prezzo).toFixed(2);
            sub = `${i.prezzo.toFixed(3)}‚Ç¨/${unita} | ${quantitaBase}${unita}`;
            
            if (tipoCarb === 'miscela' && i.percMiscela && i.prezzoOlio) {
                const litriCarb = i.euro / i.prezzo;
                const kgOlio = litriCarb * (i.percMiscela / 100);
                const costoOlio = kgOlio * i.prezzoOlio;
                sub += `<br>Miscela ${i.percMiscela}% | Olio: ${kgOlio.toFixed(2)}kg (‚Ç¨${costoOlio.toFixed(2)})`;
            }
        } else {
            val = `${i.prezzo.toFixed(3)}‚Ç¨/${unita}`;
            sub = currentLang === 'it' ? 'Solo prezzo registrato' : 'Price only recorded';
        }
        
    } else if (i.tipo === 'E') {
        icon = 'fa-route';
        color = 'var(--accent)';
        label = t('extraKm').toUpperCase();
        val = `${i.km}km`;
        sub = `${i.desc || ''}<br>${currentLang === 'it' ? 'Importo' : 'Amount'}: ‚Ç¨${i.importo.toFixed(2)}`;
    }
    
    const parts = i.data.split('/');
    const dataFormattata = `${parts[0]}/${parts[1]}`;
    const ora = i.ora || '--:--';
    
    return `
    <div class="storico-item">
        <div class="storico-info">
            <div class="tipo-label" style="color:${color};">
                <i class="fas ${icon}"></i>${label}
            </div>
            <div class="storico-date-row">
                <span>${dataFormattata}</span>
                <span class="storico-hour">${ora}</span>
            </div>
            <div class="storico-main">${val}</div>
            <div class="storico-sub">${sub}</div>
        </div>
        <button onclick="eliminaDaStorico(${i.id}, '${i.tipo}')" style="background:var(--accent); color:#fff; border:none; padding:8px 12px; border-radius:8px; font-size:12px; font-weight:bold; cursor:pointer;">
            <i class="fas fa-trash"></i>
        </button>
    </div>`;
}

function toggleMese(id) {
    const body = document.getElementById('body_' + id);
    const chev = document.getElementById('chev_' + id);
    if (!body) return;
    
    if (body.classList.contains('open')) {
        body.classList.remove('open');
        chev.style.transform = 'rotate(0deg)';
    } else {
        body.classList.add('open');
        chev.style.transform = 'rotate(180deg)';
    }
}

function getNomeMese(meseAnno) {
    const parts = meseAnno.split('/');
    const mese = parseInt(parts[0]) - 1;
    const anno = parts[1];
    const nomiMesi = currentLang === 'it' ? 
        ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'] :
        ['January','February','March','April','May','June','July','August','September','October','November','December'];
    return nomiMesi[mese] + ' ' + anno;
}

function eliminaDaStorico(id, tipo) {
    document.getElementById('btnConfermaElimina').onclick = function() {
        if (tipo === 'T') {
            db.turni = db.turni.filter(t => t.id !== id);
        } else if (tipo === 'B') {
            db.rifornimenti = db.rifornimenti.filter(r => r.id !== id);
        } else if (tipo === 'E') {
            db.extraKm = db.extraKm.filter(e => e.id !== id);
        }
        salvaDB();
        apriStorico();
        chiudiModali();
    };
    document.getElementById('modalElimina').style.display = 'flex';
}

function confermaEliminaMese(meseKey) {
    const modal = document.getElementById('modalElimina');
    const nomeMese = getNomeMese(meseKey);
    
    modal.querySelector('h3').innerText = currentLang === 'it' ? `ELIMINA ${nomeMese.toUpperCase()}` : `DELETE ${nomeMese.toUpperCase()}`;
    modal.querySelector('p').innerText = currentLang === 'it' ? 
        `ATTENZIONE: Stai per eliminare TUTTI i dati di ${nomeMese}. Questa operazione √® irreversibile.` :
        `WARNING: You are about to delete ALL data from ${nomeMese}. This operation is irreversible.`;
    
    document.getElementById('btnConfermaElimina').onclick = function() {
        db.turni = db.turni.filter(t => !t.data.endsWith(meseKey));
        db.rifornimenti = db.rifornimenti.filter(r => !r.data.endsWith(meseKey));
        db.extraKm = db.extraKm.filter(e => !e.data.endsWith(meseKey));
        
        salvaDB();
        apriStorico();
        chiudiModali();
        
        setTimeout(() => {
            resetModaleElimina();
        }, 500);
    };
    
    modal.style.display = 'flex';
}

function apriReport(meseKey) {
    const [mese, anno] = meseKey.split('/').map(Number);
    generaReportSpecifico(mese, anno);
}

function generaReportSpecifico(mese, anno) {
    const nomiMesi = currentLang === 'it' ? 
        ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'] :
        ['January','February','March','April','May','June','July','August','September','October','November','December'];
    
    document.getElementById('repMonthTitle').innerText = (currentLang === 'it' ? 'RIEPILOGO MESE DI ' : 'MONTH SUMMARY OF ') + nomiMesi[mese - 1].toUpperCase() + ' ' + anno;
    
    const chiaveMese = `${mese.toString().padStart(2, '0')}/${anno}`;
    const turniMese = db.turni.filter(t => t.data.endsWith(chiaveMese));
    const rifMese = db.rifornimenti.filter(r => r.data.endsWith(chiaveMese));
    
    let htmlTurni = '';
    let tO = 0, tK = 0, tL = 0, tN = 0, tEB_Reale = 0, costoB_Stimata = 0;
    
    const taxVal = (db.tax !== undefined && db.tax !== null) ? db.tax : 22;
    
    turniMese.forEach(t => {
        const tipoCarb = t.tipoCarburante || 'benzina';
        const isBici = (t.mezzo === 'bici');
        const unita = getUnitaCarburante(tipoCarb);
        const quantita = isBici ? 0 : (t.km * (t.cons / 100));
        let costoCarb = quantita * (t.prezzo || 0);
        
        if (tipoCarb === 'miscela' && t.percMiscela && t.prezzoOlio) {
            const kgOlio = quantita * (t.percMiscela / 100);
            costoCarb += kgOlio * t.prezzoOlio;
        }
        
        let tasse = t.lordo * (taxVal / 100);
        let netto = t.lordo - tasse - costoCarb;
        
        tO += t.ore;
        tK += t.km;
        tL += t.lordo;
        tN += netto;
        costoB_Stimata += costoCarb;
        
        const consDisplay = isBici ? '-' : t.cons.toFixed(1);
        const qtyDisplay = isBici ? '-' : quantita.toFixed(1) + unita;
        
        htmlTurni += `<tr>
            <td>${t.data}</td>
            <td>‚Ç¨${t.lordo.toFixed(2)}</td>
            <td>‚Ç¨${netto.toFixed(2)}</td>
            <td>${t.ore.toFixed(1)}</td>
            <td>${t.km}</td>
            <td>${consDisplay}</td>
            <td class="tipo-abbrev-mi">${t.mezzo ? t.mezzo.charAt(0).toUpperCase() : '-'}</td>
            <td>${qtyDisplay}</td>
        </tr>`;
    });
    
    document.getElementById('repTurniBody').innerHTML = htmlTurni || '<tr><td colspan="8" style="text-align:center;">' + (currentLang === 'it' ? 'Nessun turno' : 'No shifts') + '</td></tr>';
    
    let htmlBenza = '';
    rifMese.forEach(r => {
        const tipoCarb = r.tipo || 'benzina';
        const unita = getUnitaCarburante(tipoCarb);
        const nomeCarb = getNomeCarburante(tipoCarb);
        
        if (r.euro > 0) {
            tEB_Reale += r.euro;
            const qty = (r.euro / r.prezzo).toFixed(2);
            htmlBenza += `<tr>
                <td>${r.data}</td>
                <td>${nomeCarb}</td>
                <td>‚Ç¨${r.euro.toFixed(2)}</td>
                <td>${r.prezzo.toFixed(3)}‚Ç¨/${unita}</td>
                <td>${qty}${unita}</td>
            </tr>`;
        } else {
            htmlBenza += `<tr>
                <td>${r.data}</td>
                <td>${nomeCarb}</td>
                <td>-</td>
                <td>${r.prezzo.toFixed(3)}‚Ç¨/${unita}</td>
                <td>-</td>
            </tr>`;
        }
    });
    
    document.getElementById('repBenzaBody').innerHTML = htmlBenza || '<tr><td colspan="5" style="text-align:center;">' + (currentLang === 'it' ? 'Nessun rifornimento' : 'No refuels') + '</td></tr>';
    
    const taxV = tL * (taxVal / 100);
    const costoMedioKm = tK > 0 ? (costoB_Stimata / tK).toFixed(3) : '0.000';
    
    const turniPerCarburante = {};
    turniMese.forEach(t => {
        if (t.mezzo === 'bici') return;
        const tipoCarb = t.tipoCarburante || 'benzina';
        if (!turniPerCarburante[tipoCarb]) {
            turniPerCarburante[tipoCarb] = {
                turni: [],
                ore: 0,
                km: 0,
                quantita: 0,
                lordo: 0,
                netto: 0,
                costoCarb: 0
            };
        }
        
        const quantita = t.km * (t.cons / 100);
        let costoCarb = quantita * (t.prezzo || 0);
        
        if (tipoCarb === 'miscela' && t.percMiscela && t.prezzoOlio) {
            const kgOlio = quantita * (t.percMiscela / 100);
            costoCarb += kgOlio * t.prezzoOlio;
        }
        
        let tasse = t.lordo * (taxVal / 100);
        let netto = t.lordo - tasse - costoCarb;
        
        turniPerCarburante[tipoCarb].turni.push(t);
        turniPerCarburante[tipoCarb].ore += t.ore;
        turniPerCarburante[tipoCarb].km += t.km;
        turniPerCarburante[tipoCarb].quantita += quantita;
        turniPerCarburante[tipoCarb].lordo += t.lordo;
        turniPerCarburante[tipoCarb].netto += netto;
        turniPerCarburante[tipoCarb].costoCarb += costoCarb;
    });
    
    let htmlDettagliCarb = '';
    Object.keys(turniPerCarburante).forEach(tipo => {
        const dati = turniPerCarburante[tipo];
        const unita = getUnitaCarburante(tipo);
        const icona = getIconaCarburante(tipo);
        const nome = getNomeCarburante(tipo);
        const efficienza = dati.quantita > 0 ? (dati.km / dati.quantita).toFixed(1) : '0.0';
        const euroOra = dati.ore > 0 ? (dati.netto / dati.ore).toFixed(2) : '0.00';
        const costoKm = dati.km > 0 ? (dati.costoCarb / dati.km).toFixed(3) : '0.000';
        
        htmlDettagliCarb += '<div class="report-section" style="border: 2px solid #000; padding: 15px; margin-bottom: 20px; page-break-inside: avoid;">';
        htmlDettagliCarb += '<h3 style="margin-top: 0; text-align:center; font-size:14px;">' + icona + ' ' + nome.toUpperCase() + '</h3>';
        htmlDettagliCarb += '<div class="summary-row" style="font-size:10px;"><span>' + (currentLang === 'it' ? 'Turni:' : 'Shifts:') + '</span><span>' + dati.turni.length + '</span></div>';
        htmlDettagliCarb += '<div class="summary-row" style="font-size:10px;"><span>' + (currentLang === 'it' ? 'Ore lavorate:' : 'Worked hours:') + '</span><span>' + dati.ore.toFixed(1) + 'h</span></div>';
        htmlDettagliCarb += '<div class="summary-row" style="font-size:10px;"><span>' + (currentLang === 'it' ? 'Km:' : 'Distance:') + '</span><span>' + dati.km + getDistanceUnit() + '</span></div>';
        htmlDettagliCarb += '<div class="summary-row" style="font-size:10px;"><span>' + (currentLang === 'it' ? 'Consumo totale:' : 'Total consumption:') + '</span><span>' + dati.quantita.toFixed(1) + unita + '</span></div>';
        htmlDettagliCarb += '<div class="summary-row" style="font-size:10px;"><span>' + (currentLang === 'it' ? 'Efficienza:' : 'Efficiency:') + '</span><span>' + efficienza + ' ' + getDistanceUnit() + '/' + unita + '</span></div>';
        htmlDettagliCarb += '<div class="summary-row" style="font-size:10px;"><span>' + (currentLang === 'it' ? 'Costo carburante:' : 'Fuel cost:') + '</span><span>‚Ç¨' + dati.costoCarb.toFixed(2) + '</span></div>';
        htmlDettagliCarb += '<div class="summary-row" style="font-size:10px;"><span>' + (currentLang === 'it' ? 'Costo/km:' : 'Cost/unit:') + '</span><span>‚Ç¨' + costoKm + '/' + getDistanceUnit() + '</span></div>';
        htmlDettagliCarb += '<div class="summary-row" style="font-size:10px; font-weight:bold; border-top:1px solid #000; margin-top:4px; padding-top:4px;"><span>' + (currentLang === 'it' ? 'Lordo:' : 'Gross:') + '</span><span>‚Ç¨' + dati.lordo.toFixed(2) + '</span></div>';
        htmlDettagliCarb += '<div class="summary-row" style="font-size:10px; font-weight:bold;"><span>' + (currentLang === 'it' ? 'Netto:' : 'Net:') + '</span><span>‚Ç¨' + dati.netto.toFixed(2) + '</span></div>';
        htmlDettagliCarb += '<div class="summary-row" style="font-size:10px; font-weight:bold;"><span>' + (currentLang === 'it' ? 'Resa oraria:' : 'Hourly yield:') + '</span><span>‚Ç¨' + euroOra + '/h</span></div>';
        htmlDettagliCarb += '</div>';
    });
    
    document.getElementById('repDettagliCarburanti').innerHTML = htmlDettagliCarb;
    
    const kmEx = (db.extraKm || []).filter(e => e.data.endsWith(chiaveMese)).reduce((sum, e) => sum + e.km, 0);
    const spesaEx = (db.extraKm || []).filter(e => e.data.endsWith(chiaveMese)).reduce((sum, e) => sum + e.importo, 0);
    
    document.getElementById('repFinalSummary').innerHTML =
'<div class="report-section" style="border:2px solid #000; padding:15px; margin-bottom:20px; page-break-inside:avoid;">' +
'<div style="text-align:center; font-weight:bold; font-size:11px; text-transform:uppercase; margin-bottom:8px; padding-bottom:5px; border-bottom:2px solid #000;">' + (currentLang === 'it' ? 'MONITORAGGIO EXTRA LAVORO' : 'EXTRA WORK MONITORING') + '</div>' +
'<div class="summary-row"><span>' + (currentLang === 'it' ? 'KM EXTRA:' : 'EXTRA DISTANCE:') + '</span><span>' + kmEx + ' ' + getDistanceUnit() + '</span></div>' +
'<div class="summary-row"><span>' + (currentLang === 'it' ? 'SPESA KM EXTRA:' : 'EXTRA EXPENSE:') + '</span><span>‚Ç¨' + spesaEx.toFixed(2) + '</span></div>' +
'<hr style="border:0; border-top:2px solid #000; margin:10px 0;">' +
'<div style="text-align:center; font-weight:bold; font-size:11px; text-transform:uppercase; margin-bottom:8px;">' + (currentLang === 'it' ? 'RIEPILOGO GENERALE TURNI' : 'GENERAL SHIFTS SUMMARY') + '</div>' +
'<div class="summary-row"><span>' + (currentLang === 'it' ? 'ORE TOTALI:' : 'TOTAL HOURS:') + '</span><span>' + tO.toFixed(1) + 'h</span></div>' +
'<div class="summary-row"><span>' + (currentLang === 'it' ? 'KM TURNI:' : 'SHIFT DISTANCE:') + '</span><span>' + Math.ceil(tK) + ' ' + getDistanceUnit() + '</span></div>' +
'<div class="summary-row" style="font-weight:bold;"><span>' + (currentLang === 'it' ? 'TOTALE KM:' : 'TOTAL DISTANCE:') + '</span><span>' + Math.ceil(tK) + ' ' + getDistanceUnit() + '</span></div>' +
'<div class="summary-row"><span>' + (currentLang === 'it' ? 'SPESA CARBURANTE:' : 'FUEL EXPENSE:') + '</span><span>‚Ç¨' + tEB_Reale.toFixed(2) + '</span></div>' +
'<div class="summary-row"><span>' + (currentLang === 'it' ? 'COSTO MEDIO/KM:' : 'AVG COST/UNIT:') + '</span><span>‚Ç¨' + costoMedioKm + '</span></div>' +
'<hr style="border:0; border-top:2px solid #000; margin:10px 0;">' +
'<div class="summary-row"><span>' + (currentLang === 'it' ? 'LORDO TOTALE:' : 'TOTAL GROSS:') + '</span><span>‚Ç¨' + tL.toFixed(2) + '</span></div>' +
'<div class="summary-row"><span>' + (currentLang === 'it' ? 'TASSE' : 'TAXES') + ' (' + taxVal + '%):</span><span>-‚Ç¨' + taxV.toFixed(2) + '</span></div>' +
'<div class="summary-row"><span>' + (currentLang === 'it' ? 'CARBURANTE:' : 'FUEL:') + '</span><span>-‚Ç¨' + costoB_Stimata.toFixed(2) + '</span></div>' +
'<div class="summary-row total"><span>' + (currentLang === 'it' ? 'NETTO FINALE:' : 'FINAL NET:') + '</span><span>‚Ç¨' + (tL - taxV - costoB_Stimata).toFixed(2) + '</span></div>' +
'</div>';
    
    document.getElementById('histView').style.display = 'none';
    document.getElementById('reportView').style.display = 'flex';
}

function generaReport() {
    if (db.turni.length === 0) {
        mostraAlertGrafico(t('alertNoData'), t('alertNoDataMsg'));
        return;
    }
    
    const n = new Date();
    const mesePredefinito = n.getMonth() + 1;
    const annoPredefinito = n.getFullYear();
    
    let meseSelezionato = prompt(t('reportMonth') + " (1-12):", mesePredefinito);
    if (!meseSelezionato) return;
    meseSelezionato = parseInt(meseSelezionato);
    
    let annoSelezionato = prompt(t('reportYear') + ":", annoPredefinito);
    if (!annoSelezionato) return;
    annoSelezionato = parseInt(annoSelezionato);
    
    generaReportSpecifico(meseSelezionato, annoSelezionato);
}

function salvaGiornata() {
    alert(currentLang === 'it' ? 'Salvataggio giornata non implementato in questa versione demo.' : 'Save day not implemented in this demo version.');
}

function resetGiornata() {
    const modal = document.getElementById('modalElimina');
    modal.querySelector('h3').innerText = t('alertResetConfirm');
    modal.querySelector('p').innerText = t('alertResetConfirmMsg');
    document.getElementById('btnConfermaElimina').onclick = function() {
        eseguiResetGiornata();
    };
    modal.style.display = 'flex';
}

function eseguiResetGiornata() {
    oggi = 0; ieri = 0; mese = 0; giornaliero = 0;
    oreLavorate = 0; kmPercorsi = 0; guadagnoLordo = 0; guadagnoNetto = 0; totCarburante = 0;
    mezzoSelezionato = '';
    
    const campiInput = ['oggi','ieri','mese','giornaliero','tH','tKm','tL','tN','tMezzo','tC','tCarburante'];
    campiInput.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
    });
    
    document.getElementById('labelMezzo').innerText = t('vehicle');
    document.getElementById('labelCarburanteTurno').innerText = t('modalTurnFuel');
    
    ricalcolaTutto();
    chiudiModali();
}

let safeUnlocked = false;
let resetTimeout;

function toggleSafeReset() {
    if (!safeUnlocked) {
        document.getElementById('safeDoor').classList.add('open');
        document.getElementById('safeLock').classList.add('unlock');
        document.getElementById('safeLock').innerHTML = '<i class="fas fa-lock-open"></i>';
        safeUnlocked = true;
        
        clearTimeout(resetTimeout);
        resetTimeout = setTimeout(() => {
            document.getElementById('safeDoor').classList.remove('open');
            document.getElementById('safeLock').classList.remove('unlock');
            document.getElementById('safeLock').innerHTML = '<i class="fas fa-lock"></i>';
            safeUnlocked = false;
        }, 3000);
    } else {
        clearTimeout(resetTimeout);
        resetGiornata();
        document.getElementById('safeDoor').classList.remove('open');
        document.getElementById('safeLock').classList.remove('unlock');
        document.getElementById('safeLock').innerHTML = '<i class="fas fa-lock"></i>';
        safeUnlocked = false;
    }
}

function togglePasswordScreen() {
    const screen = document.getElementById('passwordScreen');
    screen.style.display = screen.style.display === 'none' ? 'flex' : 'none';
}

function salvaTurno() {
    const tipoCarburanteSelezionato = document.getElementById('tCarburante').value;
    const mezzoSelezionato = document.getElementById('tMezzo').value;
    
    if (mezzoSelezionato === 'bici') {
        effettuaSalvataggioTurno();
        return;
    }
    
    const ultimoRifCarburante = db.rifornimenti
        .filter(r => r.tipo === tipoCarburanteSelezionato)
        .sort((a, b) => b.id - a.id)[0];
    
    if (!ultimoRifCarburante) {
        mostraModalPrezzoIniziale(tipoCarburanteSelezionato);
        return;
    }
    
    if (tipoCarburanteSelezionato === 'miscela') {
        if (!ultimoRifCarburante.prezzoOlio || !ultimoRifCarburante.percMiscela) {
            mostraModalPrezzoIniziale(tipoCarburanteSelezionato);
            return;
        }
    }
    
    effettuaSalvataggioTurno();
}

function effettuaSalvataggioTurno() {
    alert(currentLang === 'it' ? 'Salvataggio turno non implementato in questa versione demo.' : 'Save shift not implemented in this demo version.');
}

function salvaBenza() {
    alert(currentLang === 'it' ? 'Salvataggio rifornimento non implementato in questa versione demo.' : 'Save refuel not implemented in this demo version.');
}

function salvaExtraKm() {
    alert(currentLang === 'it' ? 'Salvataggio extra km non implementato in questa versione demo.' : 'Save extra distance not implemented in this demo version.');
}

function confermaPrezzoIniziale() {
    alert(currentLang === 'it' ? 'Conferma prezzo iniziale non implementato in questa versione demo.' : 'Confirm initial price not implemented in this demo version.');
}

function aggiornaTarget() {
    const f = `${(new Date().getMonth() + 1).toString().padStart(2, '0')}/${new Date().getFullYear()}`;
    const val = document.getElementById('targetIn').value;
    db.targets[f] = (val === "") ? null : parseFloat(val);
    salvaDB();
    ricalcolaTutto();
}

function aggiornaTax() {
    const val = document.getElementById('taxIn').value;
    db.tax = (val === "") ? null : parseFloat(val);
    salvaDB();
    ricalcolaTutto();
}

function gestisciMezzo() {
    const mezzo = document.getElementById('tMezzo').value;
    const campoCons = document.getElementById('tC');

    if (mezzo === 'bici') {
        campoCons.value = 0;
        campoCons.style.display = 'none';
    } else {
        campoCons.style.display = 'block';
        campoCons.value = '';
    }
}

function selezionaMezzo(valore, testo) {
    document.getElementById('tMezzo').value = valore;
    document.getElementById('labelMezzo').innerText = testo;
    
    gestisciMezzo();
    document.getElementById('modalSelectMezzo').style.display = 'none';
}

function selezionaCarburanteTurno(tipo, testo) {
    document.getElementById('tCarburante').value = tipo;
    document.getElementById('labelCarburanteTurno').innerText = testo;
    document.getElementById('modalSelectCarburanteTurno').style.display = 'none';
    
    const campoConsumo = document.getElementById('tC');
    if (tipo === 'metano') {
        campoConsumo.placeholder = t('modalTurnConsumptionKg');
    } else {
        campoConsumo.placeholder = unitSystem === 'imperial' ? t('modalTurnConsumptionMiles') : t('modalTurnConsumption');
    }
    
    localStorage.setItem('ultimo_carburante_turno', tipo);
    localStorage.setItem('ultimo_carburante_turno_label', testo);
}

function selezionaCarburanteExtra(tipo, testo) {
    document.getElementById('extraCarburanteInput').value = tipo;
    document.getElementById('labelCarburanteExtra').innerText = testo;
    document.getElementById('modalSelectCarburanteExtra').style.display = 'none';
}

function selezionaCarburante(tipo, testo) {
    document.getElementById('bTipo').value = tipo;
    document.getElementById('labelCarburante').innerText = testo;
    
    const placeholder = document.getElementById('bP');
    const campiMiscela = document.getElementById('campiMiscela');
    
    if (tipo === 'metano') {
        placeholder.placeholder = t('modalFuelPriceKg');
    } else {
        placeholder.placeholder = unitSystem === 'imperial' ? t('modalFuelPriceGal') : t('modalFuelPrice');
    }
    
    if (tipo === 'miscela') {
        campiMiscela.style.display = 'block';
    } else {
        campiMiscela.style.display = 'none';
    }
    
    document.getElementById('modalSelectCarburante').style.display = 'none';
}

function mostraModalPrezzoIniziale(tipoCarburante) {
    tipoCarburantePrezzoIniziale = tipoCarburante;
    const unita = getUnitaCarburante(tipoCarburante);
    const nomeCarb = getNomeCarburante(tipoCarburante);
    const icona = getIconaCarburante(tipoCarburante);
    
    document.getElementById('titlePrezzoIniziale').innerText = `${icona} ${t('initialPriceTitle')} ${nomeCarb.toUpperCase()}`;
    document.getElementById('descPrezzoIniziale').innerText = t('initialPriceDesc').replace('{fuel}', nomeCarb).replace('{unit}', unita);
    
    const campiOlio = document.getElementById('campiOlioInizio');
    if (tipoCarburante === 'miscela') {
        campiOlio.style.display = 'block';
    } else {
        campiOlio.style.display = 'none';
    }
    
    document.getElementById('pIniziale').value = '';
    document.getElementById('pPercMiscelaInizio').value = '';
    document.getElementById('pOlioInizio').value = '';
    
    document.getElementById('btnSavePriceInit').innerText = t('initialPriceSave').toUpperCase();
    document.getElementById('btnCancelPriceInit').innerText = t('initialPriceClose').toUpperCase();
    
    document.getElementById('modalInizio').style.display = 'flex';
}

function mostraAlertGrafico(titolo, messaggio) {
    const modal = document.getElementById('modalElimina');
    const btnConferma = document.getElementById('btnConfermaElimina');
    const btnAnnulla = modal.querySelector('.btn-confirm-cancel');
    modal.querySelector('h3').innerText = titolo;
    modal.querySelector('p').innerText = messaggio;
    btnConferma.innerText = t('okBtn');
    btnConferma.style.backgroundColor = "var(--primary)";
    btnConferma.onclick = function() { chiudiModali(); resetModaleElimina(); };
    if(btnAnnulla) btnAnnulla.style.display = "none";
    modal.style.display = 'flex';
}

function resetModaleElimina() {
    const modal = document.getElementById('modalElimina');
    const btnConferma = document.getElementById('btnConfermaElimina');
    const btnAnnulla = modal.querySelector('.btn-confirm-cancel');
    setTimeout(() => {
        modal.querySelector('h3').innerText = t('confirmDelete');
        modal.querySelector('p').innerText = t('confirmDeleteMsg');
        btnConferma.innerText = t('confirmDeleteBtn');
        btnConferma.style.backgroundColor = "";
        if(btnAnnulla) btnAnnulla.style.display = "block";
    }, 500);
}

function confermaEliminaAnno(anno) {
    annoDaEliminare = anno;
    const modal = document.getElementById('modalElimina');
    
    modal.querySelector('h3').innerText = t('deleteYear') + " " + anno;
    modal.querySelector('p').innerText = t('deleteYearMsg').replace('{year}', anno);
    
    document.getElementById('btnConfermaElimina').onclick = function() {
        eseguiEliminazioneAnno();
    };
    
    modal.style.display = 'flex';
}

function eseguiEliminazioneAnno() {
    if (!annoDaEliminare) return;

    db.turni = db.turni.filter(t => !t.data.endsWith(annoDaEliminare));
    db.rifornimenti = db.rifornimenti.filter(r => !r.data.endsWith(annoDaEliminare));
    db.extraKm = db.extraKm.filter(e => !e.data.endsWith(annoDaEliminare));

    salvaDB();
    apriStorico();
    chiudiModali();

    setTimeout(() => {
        const modal = document.getElementById('modalElimina');
        modal.querySelector('h3').innerText = t('confirmDelete');
        modal.querySelector('p').innerText = t('confirmDeleteMsg');
    }, 500);
}

function getUnitaCarburante(tipo) {
    return tipo === 'metano' ? 'Kg' : (unitSystem === 'imperial' ? 'Gal' : 'L');
}

function getNomeCarburante(tipo) {
    const nomi = {
        'benzina': t('fuelGasoline'),
        'diesel': t('fuelDiesel'),
        'gpl': t('fuelGpl'),
        'metano': t('fuelMethane'),
        'miscela': t('fuelMix')
    };
    return nomi[tipo] || (currentLang === 'it' ? 'carburante' : 'fuel');
}

function getIconaCarburante(tipo) {
    const icone = {
        'benzina': '‚õΩ',
        'diesel': 'üõ¢Ô∏è',
        'gpl': 'üîµ',
        'metano': 'üí®',
        'miscela': 'üîÄ'
    };
    return icone[tipo] || '‚õΩ';
}

function formattaPrezzo(input) {
    let val = input.value.replace(',', '.');
    if (val.split('.').length > 2) {
        val = val.slice(0, val.lastIndexOf('.'));
    }
    input.value = val;
}

function salvaBackup() {
    const dataStr = JSON.stringify(db, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'ridertracker_backup.json';
    link.click();
}

function mostraModalBackup() {
    document.getElementById('modalBackupExport').style.display = 'flex';
}

function accettaBackup() {
    chiudiModali();
    salvaBackup();
}

function rifiutaBackup() {
    chiudiModali();
}

function confermaReset() {
    if (confirm(currentLang === 'it' ? 'ULTIMA CONFERMA: Eliminare tutto?' : 'FINAL CONFIRM: Delete everything?')) {
        localStorage.clear();
        location.reload();
    }
}

function apriMulti(tipo) {
    alert(currentLang === 'it' ? 'Dettaglio multi non implementato in questa versione demo.' : 'Multi detail not implemented in this demo version.');
}

function apriResaView() {
    alert(currentLang === 'it' ? 'Vista resa non implementata in questa versione demo.' : 'Yield view not implemented in this demo version.');
}

function chiudiResaView() {
    document.getElementById('resaView').style.display = 'none';
    document.getElementById('reportView').style.display = 'flex';
}

function isDataFutura(giorno, mese, anno) {
    const now = new Date();
    const dataSelezionata = new Date(anno, mese - 1, giorno);
    return dataSelezionata > now;
}

function aggiornaDBConTipoCarburante() {
    db.turni.forEach(t => {
        if (!t.tipoCarburante) {
            t.tipoCarburante = 'benzina';
        }
    });
    
    db.rifornimenti.forEach(r => {
        if (!r.tipo) {
            r.tipo = 'benzina';
        }
    });
    
    salvaDB();
}

function verificaPassword() {
    const inputPassword = document.getElementById('passwordInput').value;
    const passwordCorretta = 'riderpro2025';
    
    if (inputPassword === passwordCorretta) {
        document.getElementById('passwordScreen').style.display = 'none';
        document.getElementById('mainContainer').style.display = 'block';
        localStorage.setItem('app_authenticated', 'true');
        aggiornaInterfaccia();
    } else {
        document.getElementById('passwordError').innerText = t('passwordError');
        document.getElementById('passwordError').style.display = 'block';
        document.getElementById('passwordInput').value = '';
    }
}

window.addEventListener('DOMContentLoaded', function() {
    const isAuthenticated = localStorage.getItem('app_authenticated');
    if (isAuthenticated === 'true') {
        document.getElementById('passwordScreen').style.display = 'none';
        document.getElementById('mainContainer').style.display = 'block';
    }
    
    currentLang = localStorage.getItem('app_lang') || 'it';
    unitSystem = localStorage.getItem('app_unit_system') || 'metric';
    aggiornaPulsantiLingua();
    aggiornaInterfaccia();
});

window.onload = function() {
    caricaDB();
    aggiornaDBConTipoCarburante();
    calcola();
    startClock();
    checkFineMese();
    gestisciTastiera();
    if('serviceWorker' in navigator) {
        navigator.serviceWorker.register('service-worker.js');
    }
};
</script>

<script>
const MONTHS_IT = ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];
const MONTHS_EN = ["January","February","March","April","May","June","July","August","September","October","November","December"];

if (typeof translations !== 'undefined') {
  translations.it = Object.assign(translations.it || {}, {
    cancel:"ANNULLA", save:"SALVA", saveContinue:"SALVA E CONTINUA",
    confirmResetTitle:"CONFERMA RESET", confirmResetMsg:"Vuoi azzerare tutto il database?",
    endMonthTitle:"FINE MESE", endMonthMsg:"Il mese √® terminato.",
    selectFuel:"SELEZIONA CARBURANTE", selectVehicle:"SELEZIONA MEZZO",
    newShift:"NUOVO TURNO", insert:"INSERISCI",
    grossEuro:"Lordo (‚Ç¨)", hoursWorked:"Ore lavorate", kmDone:"Km percorsi",
    consumption:"Consumo:(Litri o Kg)/100 km",
    invalidPrice:"PREZZO NON VALIDO", invalidPriceMsg:"Inserisci un prezzo valido per il carburante",
    mixIncomplete:"DATI MISCELA INCOMPLETI", mixIncompleteMsg:"Per la miscela devi inserire sia la percentuale che il prezzo dell'olio al kg.",
    noDataArchive:"Nessun dato in archivio",
    deleteConfirm:"Conferma Eliminazione",
    deleteMsg:"Sei sicuro di voler eliminare questo elemento dallo storico?",
    deleteYear:"ELIMINA ANNO",
    warning:"ATTENZIONE"
  });

  translations.en = Object.assign(translations.en || {}, {
    cancel:"CANCEL", save:"SAVE", saveContinue:"SAVE AND CONTINUE",
    confirmResetTitle:"CONFIRM RESET", confirmResetMsg:"Do you want to reset the entire database?",
    endMonthTitle:"END OF MONTH", endMonthMsg:"The month has ended.",
    selectFuel:"SELECT FUEL", selectVehicle:"SELECT VEHICLE",
    newShift:"NEW SHIFT", insert:"INSERT",
    grossEuro:"Gross (‚Ç¨)", hoursWorked:"Hours worked", kmDone:"Km traveled",
    consumption:"Consumption:(Liters or Kg)/100 km",
    invalidPrice:"INVALID PRICE", invalidPriceMsg:"Enter a valid fuel price",
    mixIncomplete:"INCOMPLETE MIX DATA", mixIncompleteMsg:"For mix fuel you must enter both percentage and oil price per kg.",
    noDataArchive:"No data in archive",
    deleteConfirm:"Confirm Deletion",
    deleteMsg:"Are you sure you want to delete this item from history?",
    deleteYear:"DELETE YEAR",
    warning:"WARNING"
  });
}

function getNomeMese(key){
  const m = parseInt(key.split('/')[0],10)-1;
  return (currentLang==='en'?MONTHS_EN:MONTHS_IT)[m];
}
</script>


<script>
const FULL_TRANSLATION_MAP = {
  "ANNULLA":"CANCEL",
  "SALVA":"SAVE",
  "SALVA E CONTINUA":"SAVE AND CONTINUE",
  "Conferma Reset":"CONFIRM RESET",
  "Vuoi azzerare tutto il database?":"Do you want to reset the entire database?",
  "FINE MESE":"END OF MONTH",
  "Il mese √® terminato.":"The month has ended.",
  "Nessun dato in archivio":"No data in archive",
  "Conferma Eliminazione":"Confirm Deletion",
  "Sei sicuro di voler eliminare questo elemento dallo storico?":"Are you sure you want to delete this item from history?",
  "ELIMINA ANNO":"DELETE YEAR",
  "ATTENZIONE":"WARNING",
  "PREZZO NON VALIDO":"INVALID PRICE",
  "Inserisci un prezzo valido per il carburante":"Enter a valid fuel price",
  "DATI MISCELA INCOMPLETI":"INCOMPLETE MIX DATA",
  "Per la miscela devi inserire sia la percentuale che il prezzo dell'olio al kg.":"For mix fuel you must enter both percentage and oil price per kg."
};

function translateAllStaticText() {
  if (currentLang !== 'en') return;
  const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, null, false);
  let node;
  while(node = walker.nextNode()) {
    const txt = node.nodeValue.trim();
    if (FULL_TRANSLATION_MAP[txt]) {
      node.nodeValue = FULL_TRANSLATION_MAP[txt];
    }
  }
}

const originalChangeLang = cambiaLingua;
cambiaLingua = function(lang){
  originalChangeLang(lang);
  setTimeout(translateAllStaticText, 50);
};

document.addEventListener("DOMContentLoaded", () => {
  setTimeout(translateAllStaticText, 100);
});
</script>

</body>
</html>
